<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" />

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.07.19 -->
        <title>Invenio Stats Dashboard - Invenio Stats Dashboard 0.1.0-alpha1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=25af2a20" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #2b2b2b;
  --color-code-foreground: #f8f8f2;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     ⚠️  This is a pre-alpha package. Things may be broken. <a href='https://github.com/MESH-Research/invenio-stats-dashboard' target='_blank'>View on GitHub</a> 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Invenio Stats Dashboard 0.1.0-alpha1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <span class="sidebar-brand-text">Invenio Stats Dashboard 0.1.0-alpha1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul>
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Invenio Stats Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="setup.html">Setup and Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/MESH-Research/invenio-stats-dashboard/blob/main/docs/source/README.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/MESH-Research/invenio-stats-dashboard/edit/main/docs/source/README.md" rel="edit" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section class="tex2jax_ignore mathjax_ignore" id="invenio-stats-dashboard">
<h1>Invenio Stats Dashboard<a class="headerlink" href="#invenio-stats-dashboard" title="Link to this heading">¶</a></h1>
<p><strong>Pre-alpha version. Not ready for production use. Some things currently don’t work!</strong></p>
<p>Copyright 2025, MESH Research</p>
<p>Licensed under the MIT License. See LICENSE file for details.</p>
<section id="current-known-issues">
<h2>Current Known Issues<a class="headerlink" href="#current-known-issues" title="Link to this heading">¶</a></h2>
<ul class="simple">
<li><p>the <code class="docutils literal notranslate"><span class="pre">-background</span></code> versions of CLI commands are working but not creating the correct PID files, so the <code class="docutils literal notranslate"><span class="pre">status</span></code> and <code class="docutils literal notranslate"><span class="pre">cancel</span></code> sub-commands are not working correctly. We need to manage the background processes manually for now. But the process logs are still being captured correctly in the /tmp folder.</p></li>
<li><p>the record delta aggregator is not working properly when using the publication date as the basis for the aggregation. It is missing records published before the first record was created. This also throws off the record snapshot aggregator when using the publication date as the basis for the aggregation.</p></li>
<li><p>Not a problem, but need to clarify that the “affiliations” subcounts count the <em>number of creators/contributors</em> to records with the affiliation (i.e., the number of “contributions”), not the <em>number of records</em> with the affiliation.</p></li>
</ul>
</section>
<section id="overview">
<h2>Overview<a class="headerlink" href="#overview" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension provides global and community statistics recording and reporting for an InvenioRDM instance. It provides a highly configurable dashboard for viewing and analyzing statistics for the instance and each of its communities. The extension makes available time-series data for each community and the instance as a whole, including:</p>
<ul class="simple">
<li><p>running cumulative totals and delta changes for a given date range</p>
<ul>
<li><p>number of records and files</p></li>
<li><p>file data volume</p></li>
<li><p>number of unique uploaders</p></li>
<li><p>number of unique views and downloads</p></li>
</ul>
</li>
<li><p>subcounts for each metric broken down by a configurable list of metadata fields like</p>
<ul>
<li><p>resource type</p></li>
<li><p>access status (open, restricted, etc.)</p></li>
<li><p>language</p></li>
<li><p>creator/contributor affiliation</p></li>
<li><p>funding organization</p></li>
<li><p>subject heading</p></li>
<li><p>publisher name</p></li>
<li><p>periodical title</p></li>
<li><p>file type</p></li>
</ul>
</li>
<li><p>subcounts for view/download metrics broken down by</p>
<ul>
<li><p>referrer domain</p></li>
<li><p>visitor country</p></li>
</ul>
</li>
</ul>
<p>The extension provides:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Layer</p></th>
<th class="head"><p>Component</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>data-layer</p></td>
<td><p>storage of pre-aggregated statistics (daily cumulative snapshots and deltas) for each community and for the instance as a whole</p></td>
</tr>
<tr class="row-odd"><td><p>service-layer</p></td>
<td><p>aggregation of the community and global statistics on a regular schedule, along with service components to record community add/remove events</p></td>
</tr>
<tr class="row-even"><td><p>presentation-layer</p></td>
<td><p>API access to the aggregated daily statistics via the <code class="docutils literal notranslate"><span class="pre">/api/stats</span></code> endpoint</p></td>
</tr>
<tr class="row-odd"><td><p></p></td>
<td><p>Jinja2 templates to display React-based global and community statistics dashboards</p></td>
</tr>
<tr class="row-even"><td><p></p></td>
<td><p>menu configuration options to add the global statistics dashboard to site-wide navigation</p></td>
</tr>
</tbody>
</table>
</div>
<p>Most initial setup of the statistics infrastructure is handled automatically when the module is installed. In existing InvenioRDM instances, this includes not only setup of the necessary search indices, but also:</p>
<ul class="simple">
<li><p>migration of historical indexed usage events to the expanded mappings with added community and record metadata</p></li>
<li><p>initial indexing of the community membership events for existing records (when a record is added to or removed from a community)</p></li>
<li><p>progressive aggregation of historical statistics
This initial setup is handled by the background tasks that run on a regular schedule to aggregate the statistics. If the instance has a large number of records, this may up to a day or more to complete.</p></li>
</ul>
<p>The module also provides a set of utility classes and functions, along with cli commands, to facilitate setup and maintenance of the statistics infrastructure.</p>
</section>
<section id="todos">
<h2>TODOs<a class="headerlink" href="#todos" title="Link to this heading">¶</a></h2>
<ul class="contains-task-list simple">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> decide whether to rename the package <code class="docutils literal notranslate"><span class="pre">invenio-community-stats</span></code></p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> add config flag to switch UI between test data and production data</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> testing</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> move all tests from centralized KCWorks test suite into this package</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> fix failing tests</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> expand test coverage</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> search indexing</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> add dynamic creation of index templates based on subcount configurations</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> make view and download event factories use the subcounts configuration</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> aggregation</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> refactor CommunityUsageSnapshotAggregator for the enriched event document structure</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> ensure CommunityUsageDeltaAggregator can handle large volumes of records gracefully (paginate the query, batch the aggregations)</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> get tests for aggregator classes working</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> get tests for queries working with refactored code</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> set up a check in aggregator classes to ensure that view/download event migration has been completed before running the aggregator tasks</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> set up automatic triggering of the startup tasks (index community events, migrate usage events) when the aggregators first run</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> add opensearch health and memory usage checks to the aggregator classes (as in the reindexing service) and quit out gracefully if necessary</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> evaluate the viability of the “published” record aggregators (currently not working because of inherent issue of published dates being retroactive)</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> UI components</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> add proper loading states to the dashboard components</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> add an updated timestamp to the dashboard views</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> fix state problems with chart views</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> add custom date range picker to the dashboard views</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> add ReactOverridable support for each of the React components</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> add mechanism for adding custom React components to the dashboard views (entry point providing file paths and component labels, to be imported in components_map.js?)</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> evaluate whether additional default components are needed</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> add <code class="docutils literal notranslate"><span class="pre">invenio-communities</span></code> custom field to provide per-community configuration of the dashboard layout</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> client-side data handling</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> add client-side caching of the stats data to display while new data is loading (current implementation with IndexedDB is not working)</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> update client-side data transformer to use the configurable subcounts</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> UI theming</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> move default CSS into this package</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" checked="checked" disabled="disabled" type="checkbox"> finish basic theming of the global dashboard view</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> harmonize default CSS with InvenioRDM defaults</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> improve mobile responsiveness of the dashboard views</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> API requests</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> implement security policy for API queries</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> reporting</p>
<ul class="contains-task-list">
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> implement report generation (via API request? via email? generated client-side?)</p></li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> enable report download from dashboard widget</p></li>
</ul>
</li>
<li class="task-list-item"><p><input class="task-list-item-checkbox" disabled="disabled" type="checkbox"> improve documentation</p></li>
</ul>
</section>
<section id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Link to this heading">¶</a></h2>
<section id="building-on-the-invenio-stats-module">
<h3>Building on the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module<a class="headerlink" href="#building-on-the-invenio-stats-module" title="Link to this heading">¶</a></h3>
<p>Wherever possible, this module uses the infrastructure provided by the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module to store and aggregate the statistics data. The <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module handles:</p>
<ul class="simple">
<li><p>registration of new and expanded search index templates (for a new instance only)</p></li>
<li><p>registration of statistics aggregators via the <code class="docutils literal notranslate"><span class="pre">STATS_AGGREGATIONS</span></code> configuration variable</p>
<ul>
<li><p>with completely new aggregator classes that work independently of any event type</p></li>
</ul>
</li>
<li><p>registration of usage (view and download) events via the <code class="docutils literal notranslate"><span class="pre">STATS_EVENTS</span></code> configuration variable</p>
<ul>
<li><p>with new event search index templates to include community and record metadata fields in the usage events</p></li>
<li><p>with new event builder classes to include community and record metadata fields in the usage events</p></li>
</ul>
</li>
<li><p>registration of community and global statistics API responses via the <code class="docutils literal notranslate"><span class="pre">STATS_QUERIES</span></code> configuration variable</p>
<ul>
<li><p>using new query classes to build the community and global statistics API responses</p></li>
</ul>
</li>
<li><p>management of the stats API endpoint where the configured queries are exposed</p></li>
</ul>
</section>
<section id="data-layer">
<h3>Data layer<a class="headerlink" href="#data-layer" title="Link to this heading">¶</a></h3>
<p>This package provides infrastructure to pre-calculate and store daily aggregated delta and snapshot statistics for each community and the instance as a whole, with subcounts broken down by a configurable list of metadata fields. The data layer includes:</p>
<ul class="simple">
<li><p>search indices to store pre-aggregated statistics for communities and the instance as a whole</p></li>
<li><p>search index to store events for community membership changes</p></li>
<li><p>expanded usage event (view and download) search index mappings to include community and record metadata fields</p></li>
<li><p>utility service to migrate existing usage events to the expanded mappings</p></li>
<li><p>configuration to control which additional metadata fields are added to usage events to allow subcount aggregation by those fields</p></li>
<li><p>configuration to control which metadata fields are used to provide pre-calculated subcounts in all aggregated statistics</p></li>
<li><p>scheduled background tasks for hourly aggregation of the statistics</p></li>
</ul>
<section id="community-membership-events">
<h4>Community membership events<a class="headerlink" href="#community-membership-events" title="Link to this heading">¶</a></h4>
<p>Several aggregations provided by <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> depend on knowing exactly which records are in a community at a given time. These events are stored in the <code class="docutils literal notranslate"><span class="pre">stats-community-events</span></code> index. Each addition or removal of a record to/from a community is recorded as an event, along with the record’s creation and publication dates, and deletion status/date. This allows for a more efficient aggregation of the record-based statistics. The inclusion of the creation and publication dates allows for easy aggregation of stats based on when a community’s records were created or published, as well as when they were added to the community.</p>
<p>Events with a <code class="docutils literal notranslate"><span class="pre">community_id</span></code> of “global” are also used to mark the addition and removal of records to/from the global repository instance. This may seem redundant, but it allows aggregator classes to use the same logic in aggregating community stats and stats for the global instance. These global events are are also especially useful when aggregating statistics based on the record’s publication date (which presents problems for a simple range query from the record index) as well as preserving the correct historical record counts after a record is deleted.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">stats-community-events</span></code> index is configured by the index template at <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_events/os-v2/stats-community-events-v1.0.0.json</span></code>. Each event is shaped like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;community_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;record_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;1234567890&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;event_type&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;add&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;event_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;record_created_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;record_published_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2020-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;is_deleted&quot;</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;deleted_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-04&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;updated_timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is one index for each year, suffixed like this: <code class="docutils literal notranslate"><span class="pre">stats-community-events-2021</span></code>. The indices are collectively aliased to <code class="docutils literal notranslate"><span class="pre">stats-community-events</span></code>.</p>
</section>
<section id="enriched-record-usage-events">
<h4>Enriched record usage events<a class="headerlink" href="#enriched-record-usage-events" title="Link to this heading">¶</a></h4>
<p>In order to efficiently aggregate usage statistics by community, and in order to provide subcounts based on record metadata fields, the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> module enriches the standard <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> usage events with community and record metadata fields. This is done by overriding the default <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> index templates for the <code class="docutils literal notranslate"><span class="pre">stats-events-record-view</span></code> and <code class="docutils literal notranslate"><span class="pre">stats-events-file-download</span></code> indices.</p>
<p>The new index templates are identical to the default templates, but add:</p>
<ul class="simple">
<li><p>a “community_ids” field with a list of the record’s communities at the time of the event.</p></li>
<li><p>a set of additional configurable fields containing record metadata to be used for subcount aggregations</p></li>
</ul>
<p>By default, the following metadata fields are added to the enriched events:</p>
<ul class="simple">
<li><p>“resource_type”</p></li>
<li><p>“access_status”</p></li>
<li><p>“languages”</p></li>
<li><p>“subjects”</p></li>
<li><p>“publisher”</p></li>
<li><p>“journal_title”</p></li>
<li><p>“rights”</p></li>
<li><p>“funders”</p></li>
<li><p>“affiliations”</p></li>
<li><p>“file_types”</p></li>
<li><p>“periodical”</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The addition of these metadata fields does increase the size of the view and download search indices. Addition of the full set of metadata fields for each record will increase the size of the indices by approximately 100-150%.</p>
</div>
<p>The extension also overrides the default <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> event builder classes for view and download events, adding logic to record community and select metadata information to each event document.</p>
<p>These two changes are sufficient to provide the enriched data for all future usage events. If the InvenioRDM instance has existing legacy view and download events, the extension provides a utility service to migrate the existing indices to the new index template and add the missing community and record metadata fields to the existing events. For more details, see <a class="reference internal" href="#setup-and-migration"><span class="xref myst">Setup and Migration</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The default search index templates provided by the <code class="docutils literal notranslate"><span class="pre">invenio-rdm-records</span></code> package do not specify the number of shards to be used per index. On platforms like AWS, this can result in creation of 5 shard indices per month, which can be problematic for performance and cost. The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> module overrides the default templates to specify a single shard per index by default.</p>
</div>
</section>
<section id="aggregated-statistics">
<h4>Aggregated statistics<a class="headerlink" href="#aggregated-statistics" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> module provides pre-aggregated daily statistics for each community and the instance as a whole. There are four kinds of pre-aggregations:</p>
<ol class="arabic simple">
<li><p><strong>Record deltas</strong>: Daily changes in the number of records and files in the community/instance. These record the changes (additions/and removals) to the contents of a community/instance during a given day, based on the indexed record metadata and community membership events.</p></li>
<li><p><strong>Record snapshots</strong>: Daily cumulative total counts of records and files in the community/instance as of a given date. These are based on the indexed record metadata and community membership events. They are calculated fresh for each day, rather than being aggregated from the record deltas. This is because some subcounts in the aggregated record deltas (such as by subject heading) include only the day’s top values (e.g., the top 20 subject headings for the day). An accurate snapshot count requires that we include all records, not just the top values.</p></li>
<li><p><strong>Usage deltas</strong>: Daily counts for the number of views and downloads for records and files in the community/instance. These are based on the indexed usage events.</p></li>
<li><p><strong>Usage snapshots</strong>: Daily cumulative total counts of views and downloads for records and files in the community/instance as of a given date.</p></li>
</ol>
<p>Each aggregation document includes a breakdown of subcounts based on a configurable list of metadata fields. By default, the following metadata fields are used:</p>
<ul class="simple">
<li><p>“metadata.resource_type”</p></li>
<li><p>“access.status”</p></li>
<li><p>“metadata.languages”</p></li>
<li><p>“metadata.subjects”</p></li>
<li><p>“metadata.publisher”</p></li>
<li><p>“custom_fields.journal:journal.title”</p></li>
<li><p>“metadata.rights”</p></li>
<li><p>“metadata.funding.funder”</p></li>
<li><p>“metadata.creators.affiliations”</p></li>
<li><p>“metadata.contributors.affiliations”</p></li>
<li><p>“files.entries.ext”</p></li>
</ul>
<p>This allows on-the-fly display and reporting of any aggregated metrics broken down by any of these metadata fields.</p>
<p>Each aggregation is stored in a separate set of indices, one index per year, with a common alias to facilitate easy searching across all years. Each index includes daily documents with over-arching numbers for the InvenioRDM instance, as well as daily documents for each community. Each daily document includes broken-down subcounts based on record metadata fields such as resource type, access right, language, affiliation, funder, subject, publisher, and periodical.</p>
<p>With record deltas and record snapshots, there is an additional question about what to consider the “start” of a record’s
lifetime for the sake of the aggregation. In some cases it may be most useful to consider when records are actually added to a community/instance. But we
may also want to display a time series of a community’s contents based on when its records were published (the record’s <code class="docutils literal notranslate"><span class="pre">metadata.publication_date</span></code>) or when they were created in the InvenioRDM instance (the record’s <code class="docutils literal notranslate"><span class="pre">created</span></code> date).</p>
<p>So we aggregate and store three different versions of the record deltas and record snapshots aggregations for each day, based these three different “start” dates. Together with the usage delta and snapshot aggregations, this gives us a total of 8 different stored aggregation documents for each day for each community. These are stored in 8 different sets of search indices, with one index of each type per year. The indices are named like this:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-created-YYYY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-published-YYYY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-added-YYYY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-created-YYYY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-published-YYYY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-added-YYYY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-usage-delta-YYYY</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-usage-snapshot-YYYY</span></code></p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The “published” record delta aggregators are not currently working. These require significant extra logic to handle (a) the aggregation of past delta documents prior to the InvenioRDM instance’s first published record and (b) the updating of past snapshot documents when new records are added with a prior publication date.</p>
</div>
</section>
<section id="daily-record-deltas">
<h4>Daily record deltas<a class="headerlink" href="#daily-record-deltas" title="Link to this heading">¶</a></h4>
<p>The record delta aggregations track daily changes in the number of records and files in the community/instance. These aggregations are based on the metadata records in the <code class="docutils literal notranslate"><span class="pre">rdm-records-records</span></code> index and the community membership events in the <code class="docutils literal notranslate"><span class="pre">stats-community-events</span></code> index.</p>
<p>Each daily record delta document includes these fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code> (date): When the aggregation was created</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community_id</span></code> (string): The community identifier (or “global” for the instance as a whole)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">files</span></code> (object): the number of files and data volume added/removed for the day</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parents</span></code> (object): the number of parent records added/removed for the day, with subcounts for metadata-only parent records and parent records with files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">records</span></code> (object): the number of records added/removed for the day, with subcounts for metadata-only records and records with files</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">period_start</span></code> and <code class="docutils literal notranslate"><span class="pre">period_end</span></code> (date): The date range for this delta</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">uploaders</span></code> (integer): Number of unique users who uploaded records</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">subcounts</span></code> (object): breakdowns by configurable metadata fields, by default including:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">by_resource_types</span></code> (array[object]): breakdown by resource type (journal articles, datasets, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_access_statuses</span></code> (array[object]): breakdown by access status (open, restricted, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_languages</span></code> (array[object]): breakdown by deposit language (English, French, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_affiliations_contributor</span></code> (array[object]): breakdown by contributor affiliations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_affiliations_creator</span></code> (array[object]): breakdown by creator affiliations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_funders</span></code> (array[object]): breakdown by funding organizations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_subjects</span></code> (array[object]): breakdown by subject classifications</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_publishers</span></code> (array[object]): breakdown by publisher</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_periodicals</span></code> (array[object]): breakdown by journal/periodical</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_file_types</span></code> (array[object]): breakdown by file types (PDF, CSV, etc.)</p></li>
</ul>
</li>
</ul>
<p>Each of the subcounts is an array of objects with the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code> (string): The identifier for the subcount (e.g., “open”, “eng”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> (string or object): The readable label for the subcount if one is available (e.g., “open”, {“en”: “English”, “fr”: “French”}, etc.). The type of this field value depends on the type of the readable field provided in the record metadata schema.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">files</span></code> (object): The number of added/removed files and data volume for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">files</span></code> object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">parents</span></code> (object): The number of added/removed parent records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">parents</span></code> object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">records</span></code> (object): The number of added/removed records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">records</span></code> object</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each subcount array will include objects for only those subcount values that appear in that day’s added or removed records. For example, if there are no records with the “open” access status on a given day, the <code class="docutils literal notranslate"><span class="pre">by_access_statuses</span></code> subcount array will not include an object for “open”.</p>
</div>
<p>These aggregation documents are stored in a set of annual indices:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-created-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-created</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_records_delta_created/os-v2/stats-community-records-delta-created-v1.0.0.json</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-published-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-published</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_records_delta_published/os-v2/stats-community-records-delta-published-v1.0.0.json</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-added-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-records-delta-added</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_records_delta_added/os-v2/stats-community-records-delta-added-v1.0.0.json</span></code></p></li>
</ul>
</li>
</ul>
<p>Each document is shaped like this (the documents for the three different record delta indices have an identical shape, but the counts will differ):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;community_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;metadata_only&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;with_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;records&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;metadata_only&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;with_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;period_start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;period_end&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;uploaders&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;subcounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;by_resource_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;dataset&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Dataset&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;research_paper&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Research Paper&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">                        </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;by_access_statuses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;by_languages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;by_affiliations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;by_funders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;by_subjects&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;by_publishers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;by_periodicals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;by_file_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">                  </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                  </span><span class="nt">&quot;parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                  </span><span class="nt">&quot;records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">              </span><span class="p">},</span>
<span class="w">              </span><span class="nt">&quot;removed&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                  </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nt">&quot;parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                  </span><span class="nt">&quot;records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;updated_timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="daily-record-snapshots">
<h4>Daily record snapshots<a class="headerlink" href="#daily-record-snapshots" title="Link to this heading">¶</a></h4>
<p>The snapshot aggregations provide cumulative totals at specific points in time, showing the total state of the community/instance as of a given date. These aggregations are based on the metadata records in the <code class="docutils literal notranslate"><span class="pre">rdm-records-records</span></code> index and the community membership events in the <code class="docutils literal notranslate"><span class="pre">stats-community-events</span></code> index. Each snapshot document includes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">community_id</span></code> (string): The community identifier</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">snapshot_date</span></code> (date): The date of this snapshot</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code> (date): When the aggregation was created</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">total_records</span></code> (object): Total record counts (metadata-only vs with files)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">total_parents</span></code> (object): Total parent record counts (metadata-only vs with files)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">total_files</span></code> (object): Total file counts and data volume</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">total_uploaders</span></code> (integer): Total number of unique uploaders</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">subcounts</span></code> (object): Cumulative breakdowns by metadata fields, similar to deltas but showing totals rather than daily changes. By default these include:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">all_access_statuses</span></code> (array[object]): Total number of records by access status</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_file_types</span></code> (array[object]): Total number of records by file type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_rights</span></code> (array[object]): Total number of records by rights</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_resource_types</span></code> (array[object]): Total number of records by resource type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_languages</span></code> (array[object]): Top N languages by number of records (configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_affiliations_contributor</span></code> (array[object]): Top N contributor affiliations by number of records (configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_affiliations_creator</span></code> (array[object]): Top N creator affiliations by number of records (configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_funders</span></code> (array[object]): Top N funders by number of records (configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_periodicals</span></code> (array[object]): Top N journals/periodicals by number of records (configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_publishers</span></code> (array[object]): Top N publishers by number of records (configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_subjects</span></code> (array[object]): Top N subjects by number of records (configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT)</p></li>
</ul>
</li>
</ul>
<p>The subcount properties are named slightly differently from the delta aggregations. Instead of the <code class="docutils literal notranslate"><span class="pre">by_</span></code> prefix, the subcount properties will be prefixed with either <code class="docutils literal notranslate"><span class="pre">all_</span></code> or <code class="docutils literal notranslate"><span class="pre">top_</span></code>. The <code class="docutils literal notranslate"><span class="pre">all_</span></code> prefix indicates that the subcount for each day includes all values for the metadata field that have been used in the community/instance to-date. For example, the <code class="docutils literal notranslate"><span class="pre">all_access_statuses</span></code> subcount will provide a number for all access status values that appear in any record. The <code class="docutils literal notranslate"><span class="pre">top_</span></code> prefix indicates that the subcount includes only the top values for the metadata field that have been used in the community/instance to-date. For example, the <code class="docutils literal notranslate"><span class="pre">top_affiliations_contributor</span></code> subcount will provide a number for the top N contributor affiliations that have been used in the community/instance to-date (where N is configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT).</p>
<p>Each subcount array object has the same shape as the subcount objects in the corresponding delta aggregations.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">top_</span></code> subcounts provide the top values over the whole history of the community/instance, even if it does not appear in records added on the snapshot date.</p>
</div>
<p>These aggregation documents are stored in the indices:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-created-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-created</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_records_snapshot_created/os-v2/stats-community-records-snapshot-created-v1.0.0.json</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-published-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-published</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_records_snapshot_published/os-v2/stats-community-records-snapshot-published-v1.0.0.json</span></code></p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-added-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-records-snapshot-added</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_records_snapshot_added/os-v2/stats-community-records-snapshot-added-v1.0.0.json</span></code></p></li>
</ul>
</li>
</ul>
<p>Each document is shaped like this (the documents for the three different record snapshot indices have an identical shape, but the counts will differ):</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;community_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;snapshot_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;total_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;metadata_only&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;with_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;total_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;metadata_only&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;with_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;total_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">        </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;total_uploaders&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;subcounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;all_access_statuses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;open&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Open&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;records&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;metadata_only&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;with_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;metadata_only&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;with_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;files&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;all_file_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;pdf&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;PDF&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;added&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;removed&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;data_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;file_count&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">0</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;top_languages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;all_resource_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_affiliations_contributor&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_affiliations_creator&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_funders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_periodicals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_publishers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_subjects&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;updated_timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The subcounts will in practice never be empty after the first few snapshots, since even the “top_” subcounts will include the top N values to-date (where N is configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT).</p>
</div>
</section>
<section id="usage-deltas">
<h4>Usage deltas<a class="headerlink" href="#usage-deltas" title="Link to this heading">¶</a></h4>
<p>The usage delta aggregations track daily view and download counts for the community/instance as a whole. These aggregations are based on the <code class="docutils literal notranslate"><span class="pre">record-view</span></code> and <code class="docutils literal notranslate"><span class="pre">file-download</span></code> events indexed by the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module, which are enriched beforehand with community membership information and selected record metadata. Each usage delta document includes these fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">community_id</span></code> (string): The community identifier</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">period_start</span></code> and <code class="docutils literal notranslate"><span class="pre">period_end</span></code> (date): The date range for this delta</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code> (date): When the aggregation was created</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">totals</span></code> (object): Overall usage metrics for the day:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">view</span></code> (object): View event statistics</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">total_events</span></code> (integer): Total number of views</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_parents</span></code> (integer): Total number of unique parent records viewed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_records</span></code> (integer): Total number of unique records viewed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_visitors</span></code> (integer): Total number of unique visitors who viewed the records</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">download</span></code> (object): Download event statistics with data volume</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">total_events</span></code> (integer): Total number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">total_volume</span></code> (float): Total data volume of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_files</span></code> (integer): Total number of unique files downloaded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_parents</span></code> (integer): Total number of unique parent records downloaded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_records</span></code> (integer): Total number of unique records downloaded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_visitors</span></code> (integer): Total number of unique visitors</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">subcounts</span></code> (object): Detailed breakdowns by configurable metadata fields, by default including:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">by_access_statuses</span></code> (array[object]): Usage by access status</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_resource_types</span></code> (array[object]): Usage by resource type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_rights</span></code> (array[object]): Usage by rights type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_funders</span></code> (array[object]): Usage by funding organization</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_periodicals</span></code> (array[object]): Usage by journal/periodical</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_languages</span></code> (array[object]): Usage by language</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_subjects</span></code> (array[object]): Usage by subject classification</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_publishers</span></code> (array[object]): Usage by publisher</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_affiliations</span></code> (array[object]): Usage by creator/contributor affiliations</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_file_types</span></code> (array[object]): Usage by file type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_countries</span></code> (array[object]): Usage by visitor country</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_referrers</span></code> (array[object]): Usage by referrer</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Each of the subcount arrays will include objects for only those subcount values that appear in that day’s view or download events. For example, if no records with the “open” access status are viewed or downloaded on a given day, the <code class="docutils literal notranslate"><span class="pre">by_access_statuses</span></code> subcount array will not include an object for “open”.</p>
<p>Each object in the subcount arrays will have the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code> (string): The identifier for the subcount (e.g., “open”, “eng”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> (string): The label for the subcount (e.g., “Open”, “English”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">view</span></code> (object): The number of views for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">view</span></code> object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">download</span></code> (object): The number of downloads for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">download</span></code> object</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In addition to the same subcounts included in the record delta aggregations, the usage delta aggregations by default also include subcounts for visitor country and referrer domain. These too are configurable via the COMMUNITY_STATS_SUBCOUNT_CONFIGS configuration.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The counts for unique visitors, unique views, and unique downloads depend on the deduplication logic in the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module, implemented when the <code class="docutils literal notranslate"><span class="pre">record-view</span></code> and <code class="docutils literal notranslate"><span class="pre">file-download</span></code> events are indexed.</p>
</div>
<p>These aggregation documents are stored in the indices:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-usage-delta-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-usage-delta</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_usage_delta/os-v2/stats-community-usage-delta-v1.0.0.json</span></code></p></li>
</ul>
</li>
</ul>
<p>Each document is shaped like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;community_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;period_start&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;period_end&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;totals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;view&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;download&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;total_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;subcounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nt">&quot;by_access_statuses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;open&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Open&quot;</span><span class="p">,</span>
<span class="w">          </span><span class="nt">&quot;view&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">          </span><span class="p">},</span>
<span class="w">          </span><span class="nt">&quot;download&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;total_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">      </span><span class="p">],</span>
<span class="w">      </span><span class="nt">&quot;by_resource_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_rights&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_funders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_periodicals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_languages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_subjects&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_publishers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_file_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_affiliations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_countries&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">      </span><span class="nt">&quot;by_referrers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="usage-snapshots">
<h4>Usage snapshots<a class="headerlink" href="#usage-snapshots" title="Link to this heading">¶</a></h4>
<p>The usage snapshot aggregations provide cumulative view and download totals for each community/instance at the end of each day. These aggregations are based
on the <code class="docutils literal notranslate"><span class="pre">record-view</span></code> and <code class="docutils literal notranslate"><span class="pre">file-download</span></code> events indexed by the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module, which are enriched beforehand with community membership information and selected record metadata. Each usage snapshot
document includes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">community_id</span></code> (string): The community identifier</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">snapshot_date</span></code> (date): The date of this snapshot</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">timestamp</span></code> (date): When the aggregation was created</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">totals</span></code> (object): Cumulative usage metrics (similar structure to deltas but cumulative)</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">view</span></code> (object): View event statistics</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">total_events</span></code> (integer): Total number of views</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_parents</span></code> (integer): Total number of unique parent records viewed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_records</span></code> (integer): Total number of unique records viewed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_visitors</span></code> (integer): Total number of unique visitors who viewed the records</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">download</span></code> (object): Download event statistics with data volume</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">total_events</span></code> (integer): Total number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">total_volume</span></code> (float): Total data volume of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_files</span></code> (integer): Total number of unique files downloaded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_parents</span></code> (integer): Total number of unique parent records downloaded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_records</span></code> (integer): Total number of unique records downloaded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">unique_visitors</span></code> (integer): Total number of unique visitors</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">subcounts</span></code> (object): Cumulative breakdowns by metadata fields, showing total usage across all time rather than daily changes, by default including:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">all_access_statuses</span></code> (array[object]): Total number of records by access status</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_file_types</span></code> (array[object]): Total number of records by file type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_rights</span></code> (array[object]): Total number of records by rights type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">all_resource_types</span></code> (array[object]): Total number of records by resource type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_languages</span></code> (array[object]): Top N languages, calculated both by number of views and number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_affiliations</span></code> (array[object]): Top N contributor affiliations, calculated both by number of views and number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_funders</span></code> (array[object]): Top N funders, calculated both by number of views and number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_periodicals</span></code> (array[object]): Top N journals/periodicals, calculated both by number of views and number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_publishers</span></code> (array[object]): Top N publishers, calculated both by number of views and number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_subjects</span></code> (array[object]): Top N subjects, calculated both by number of views and number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_countries</span></code> (array[object]): Top N countries, calculated both by number of views and number of downloads</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">top_referrers</span></code> (array[object]): Top N referrers, calculated both by number of views and number of downloads</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Each of the <code class="docutils literal notranslate"><span class="pre">top_</span></code> subcount arrays will include objects for the top N values to-date (where N is configurable via COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT), even if they do not appear in the records added on the snapshot date.</p>
</div>
<p>Each object in the <code class="docutils literal notranslate"><span class="pre">all_</span></code> subcount arrays will have the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code> (string): The identifier for the subcount (e.g., “open”, “eng”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> (string): The label for the subcount (e.g., “Open”, “English”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">view</span></code> (object): The number of views for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">view</span></code> object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">download</span></code> (object): The number of downloads for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">download</span></code> object</p></li>
</ul>
<p>Each object in the <code class="docutils literal notranslate"><span class="pre">top_</span></code> subcount arrays will have the following fields:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">by_view</span></code> (array[object]): The top N views for the subcount item, each with the fields:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code> (string): The identifier for the subcount (e.g., “open”, “eng”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> (string): The label for the subcount (e.g., “Open”, “English”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">view</span></code> (object): The number of views for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">view</span></code> object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">download</span></code> (object): The number of downloads for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">download</span></code> object</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">by_download</span></code> (array[object]): The top N downloads for the subcount item, each with the fields:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">id</span></code> (string): The identifier for the subcount (e.g., “open”, “eng”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">label</span></code> (string): The label for the subcount (e.g., “Open”, “English”, etc.)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">view</span></code> (object): The number of views for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">view</span></code> object</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">download</span></code> (object): The number of downloads for records with the subcount item, structured as in the top-level <code class="docutils literal notranslate"><span class="pre">download</span></code> object</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The counts for unique visitors, unique views, and unique downloads depend on the deduplication logic in the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module, implemented when the <code class="docutils literal notranslate"><span class="pre">record-view</span></code> and <code class="docutils literal notranslate"><span class="pre">file-download</span></code> events are indexed.</p>
</div>
<p>These aggregation documents are stored in the indices:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">stats-community-usage-snapshot-YYYY</span></code></p>
<ul>
<li><p>alias: <code class="docutils literal notranslate"><span class="pre">stats-community-usage-snapshot</span></code></p></li>
<li><p>index template: <code class="docutils literal notranslate"><span class="pre">search_indices/stats_community_usage_snapshot/os-v2/stats-community-usage-snapshot-v1.0.0.json</span></code></p></li>
</ul>
</li>
</ul>
<p>Each document is shaped like this:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
<span class="w">    </span><span class="nt">&quot;community_id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;global&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;snapshot_date&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;timestamp&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;2021-01-01T00:00:00Z&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="nt">&quot;totals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;view&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;download&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;total_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="nt">&quot;subcounts&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nt">&quot;all_access_statuses&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">          </span><span class="p">{</span>
<span class="w">            </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;open&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;Open&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="nt">&quot;view&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="nt">&quot;download&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;total_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;unique_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">}</span>
<span class="w">        </span><span class="p">],</span>
<span class="w">        </span><span class="nt">&quot;top_languages&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;all_rights&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;all_resource_types&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_affiliations&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span><span class="nt">&quot;by_view&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;013v4ng57&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;University of California, Berkeley&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;view&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">              </span><span class="p">},</span>
<span class="w">              </span><span class="nt">&quot;download&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;total_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">],</span>
<span class="w">          </span><span class="nt">&quot;by_download&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="nt">&quot;id&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;013v4ng58&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;label&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;National Science Foundation&quot;</span><span class="p">,</span>
<span class="w">              </span><span class="nt">&quot;view&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">              </span><span class="p">},</span>
<span class="w">              </span><span class="nt">&quot;download&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nt">&quot;total_events&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;total_volume&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">1000000</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_files&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_parents&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_records&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span><span class="p">,</span>
<span class="w">                </span><span class="nt">&quot;unique_visitors&quot;</span><span class="p">:</span><span class="w"> </span><span class="mi">100</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">          </span><span class="p">]</span>
<span class="w">        </span><span class="p">},</span>
<span class="w">        </span><span class="nt">&quot;top_funders&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_periodicals&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_publishers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_subjects&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_countries&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[],</span>
<span class="w">        </span><span class="nt">&quot;top_referrers&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">[]</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="search-index-configuration">
<h4>Search index configuration<a class="headerlink" href="#search-index-configuration" title="Link to this heading">¶</a></h4>
<p>The indices used for the statistics are managed by index templates that are registered with <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> via the
aggregation configurations in the <code class="docutils literal notranslate"><span class="pre">STATS_AGGREGATIONS</span></code> configuration variable. In a new InvenioRDM instance, the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module
ensures that the templates are registered with the OpenSearch domain. and the indices are created automatically when records are first indexed.</p>
<p>For more information about the index configuration and creation process, see <a class="reference internal" href="#setup-and-migration"><span class="xref myst">Setup and Migration</span></a> below.</p>
</section>
</section>
<section id="service-layer">
<h3>Service layer<a class="headerlink" href="#service-layer" title="Link to this heading">¶</a></h3>
<p>At the service layer, this module provides:</p>
<ul class="simple">
<li><p>celery tasks to aggregate community and global instance statistics on an hourly schedule</p></li>
<li><p>service components to record community and global add/remove events</p></li>
<li><p>a <code class="docutils literal notranslate"><span class="pre">CommunityStatsService</span></code> class to facilitate programmatic access to the statistics data (accessed via the <code class="docutils literal notranslate"><span class="pre">current_community_stats_service</span></code> proxy) and handle community event record operations</p></li>
<li><p>a second <code class="docutils literal notranslate"><span class="pre">EventReindexingService</span></code> class to facilitate migration of the usage event indices (accessed via the <code class="docutils literal notranslate"><span class="pre">current_event_reindexing_service</span></code> proxy)</p></li>
<li><p>a helper <code class="docutils literal notranslate"><span class="pre">UsageEventFactory</span></code> class to generate synthetic usage events for testing</p></li>
</ul>
<p>The celery tasks are also responsible for ensuring that historical data is progressively aggregated and indexed when the extension is first installed. For more information, see <a class="reference internal" href="#setup-and-migration"><span class="xref myst">Setup and Migration</span></a> below.</p>
<section id="aggregator-classes">
<h4>Aggregator classes<a class="headerlink" href="#aggregator-classes" title="Link to this heading">¶</a></h4>
<p>The actual aggregations are performed by a set of aggregator classes registered with the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module via the <code class="docutils literal notranslate"><span class="pre">STATS_AGGREGATIONS</span></code> configuration variable. These classes are:</p>
<ul class="simple">
<li><p><strong>CommunityRecordsSnapshotCreatedAggregator</strong>: Creates snapshot aggregations based on record creation dates</p></li>
<li><p><strong>CommunityRecordsSnapshotAddedAggregator</strong>: Creates snapshot aggregations based on when records were added to communities</p></li>
<li><p><strong>CommunityRecordsSnapshotPublishedAggregator</strong>: Creates snapshot aggregations based on record publication dates</p></li>
<li><p><strong>CommunityRecordsDeltaCreatedAggregator</strong>: Creates delta aggregations based on record creation dates</p></li>
<li><p><strong>CommunityRecordsDeltaAddedAggregator</strong>: Creates delta aggregations based on when records were added to communities</p></li>
<li><p><strong>CommunityRecordsDeltaPublishedAggregator</strong>: Creates delta aggregations based on record publication dates</p></li>
<li><p><strong>CommunityUsageSnapshotAggregator</strong>: Creates usage snapshot aggregations for view and download events</p></li>
<li><p><strong>CommunityUsageDeltaAggregator</strong>: Creates usage delta aggregations for view and download events</p></li>
</ul>
<p>One additional aggregator class (<strong>CommunityEventsIndexAggregator</strong>) is registered with the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module to facilitate registration of the index template for the <code class="docutils literal notranslate"><span class="pre">stats-community-events</span></code> index. This class does not usually actually perform any aggregation, since those events are created by the service components described below. It is
only called by the utility service method that sets up the initial indexed events for an existing InvenioRDM
instance.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The aggregator classes are idempotent, meaning that they can be run multiple times without causing duplicate aggregations. This is achieved first by using the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> bookmarking mechanism to track the progress of the aggregation and begin each aggregation from the last processed date. The aggregator classes also check each time for an existing aggregation document and deleting any that are found for the same date before indexing a new one.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module expects each configured aggregation to correspond to a configured event type. The default aggregator class, along with several available properties of the <code class="docutils literal notranslate"><span class="pre">STATS_AGGREGATIONS</span></code> config objects, are designed with this kind of event-aggregation structure in mind. The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> aggregations, however, are compiling counts based on record metadata or usage events in ways that do not fit this pattern. Hence this package provides aggregator classes that are designed quite differently, although they follow some of the patterns of the default aggregator class (e.g., the use of an <code class="docutils literal notranslate"><span class="pre">agg_iter</span></code> method and the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> bookmarking mechanism). As a result, the <code class="docutils literal notranslate"><span class="pre">STATS_AGGREGATIONS</span></code> config objects for the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> aggregations include less information than what must be provided to the default aggregator class.</p>
</div>
</section>
<section id="scheduled-aggregation-of-statistics">
<h4>Scheduled aggregation of statistics<a class="headerlink" href="#scheduled-aggregation-of-statistics" title="Link to this heading">¶</a></h4>
<p>The aggregator classes are run via a celery task, tasks.aggregate_community_record_stats. This task calls the <code class="docutils literal notranslate"><span class="pre">run</span></code> method of the eight aggregator classes in turn. These methods are run sequentially by design, to avoid race conditions, and to avoid overloading the OpenSearch domain with too many concurrent requests. The task is scheduled to run hourly by default, but can be configured via the <code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_CELERYBEAT_SCHEDULE</span></code> configuration variable. The scheduled tasks can be disabled by setting the <code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_TASKS_ENABLED</span></code> configuration variable to <code class="docutils literal notranslate"><span class="pre">False</span></code>. (See <a class="reference internal" href="configuration.html"><span class="doc std std-doc">Configuration</span></a> below for more information.)</p>
</section>
<section id="aggregation-task-locking-and-catch-up-limits">
<h4>Aggregation task locking and catch-up limits<a class="headerlink" href="#aggregation-task-locking-and-catch-up-limits" title="Link to this heading">¶</a></h4>
<p>The background aggregation tasks are designed to be as efficient as possible. With large instances, though, it is theoretically possible that an aggregation task may not complete before the next aggregation task is scheduled to run. To prevent this, a lock prevents a new aggregation tasks from starting until the previous task has completed. In case a scheduled task is not able to acquire the lock, it will log a warning and skip the aggregation. Aggregation will continue normally on the next scheduled run, provided that the lock is not still held by the previous task. This locking mechanism can be disabled or configured via the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_LOCK_CONFIG</span></code> configuration variable.</p>
<p>The risk of long-running tasks is mitigated by the use of a catch-up limit. Most long-running tasks would result from the presence of historical data that must be aggregated before the current date’s aggregation can begin. The catch-up limit is set to 365 days by default, but can be configured via the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_CATCHUP_INTERVAL</span></code> configuration variable. If the catch-up limit is reached before the current date’s aggregation is complete, the task will exit and continue to catch up on the next scheduled run. See <a class="reference internal" href="#setup-and-migration"><span class="xref myst">Setup and Migration</span></a> below for more information about the catch-up process.</p>
</section>
<section id="service-components-for-community-event-tracking">
<h4>Service components for community event tracking<a class="headerlink" href="#service-components-for-community-event-tracking" title="Link to this heading">¶</a></h4>
<p>The module provides specialized service components that automatically record community membership changes. These
components hook into the following service classes and methods:</p>
<ul class="simple">
<li><p><strong>CommunityAcceptedEventComponent</strong>: Integrates with the <code class="docutils literal notranslate"><span class="pre">RequestEventsService</span></code> from <code class="docutils literal notranslate"><span class="pre">invenio-requests</span></code> and triggers on the <code class="docutils literal notranslate"><span class="pre">create</span></code> method when community inclusion, submission, or transfer requests are accepted. It automatically creates events in the <code class="docutils literal notranslate"><span class="pre">stats-community-events</span></code> index when records are added to communities through the request workflow.</p></li>
<li><p><strong>RecordCommunityEventComponent</strong>: Integrates with the <code class="docutils literal notranslate"><span class="pre">RDMRecordService</span></code> from <code class="docutils literal notranslate"><span class="pre">invenio-rdm-records</span></code> and provides three key methods:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">publish</span></code>: Called when a record is published, compares the new community membership with the previous published version to determine additions and removals</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">delete_record</span></code>: Called when a record is deleted, marks all existing community events for that record as deleted</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">restore_record</span></code>: Called when a record is restored, clears the deletion flags from all community events for that record</p></li>
</ul>
</li>
<li><p><strong>RecordCommunityEventTrackingComponent</strong>: Integrates with the <code class="docutils literal notranslate"><span class="pre">RecordCommunitiesService</span></code> from <code class="docutils literal notranslate"><span class="pre">invenio-rdm-records</span></code> and provides methods for direct community membership management:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">add</span></code>: Called when records are added to communities, creates addition events</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bulk_add</span></code>: Called for bulk community additions, processes multiple records at once</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">remove</span></code>: Called when records are removed from communities, creates removal events</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is some redundant overlap between the components for these service components, meaning that in some cases
the same user action will trigger more than one component. This will <em>not</em> result in duplicate events being created,
and it is necessary to ensure that all events are caught when community inclusion is changed using any of the
multiple possible methods.</p>
</div>
</section>
<section id="programmatic-statistics-access-service">
<h4>Programmatic statistics access service<a class="headerlink" href="#programmatic-statistics-access-service" title="Link to this heading">¶</a></h4>
<p>The module includes a CommunityStatsService class that provides a programmatic interface to the statistics data, accessed via the <code class="docutils literal notranslate"><span class="pre">current_community_stats_service</span></code> proxy. The class exposes the following public methods:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">generate_record_community_events</span></code>: Creates community add/remove events for all records in the instance that do not already have events. Can be run via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">community-events</span> <span class="pre">generate</span></code> CLI command.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">aggregate_stats</span></code>: Manually triggers the aggregation of statistics for a community or instance. Can be run via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">aggregate</span></code> CLI command.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">read_stats</span></code>: Reads the statistics data for a community or instance. Can be run via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">read</span></code> CLI command.</p></li>
</ul>
</section>
<section id="helper-class-for-usage-event-index-migration">
<h4>Helper class for usage event index migration<a class="headerlink" href="#helper-class-for-usage-event-index-migration" title="Link to this heading">¶</a></h4>
<p>The module includes an <code class="docutils literal notranslate"><span class="pre">EventReindexingService</span></code> class that can be used to migrate existing usage events to the new index templates, accessed via the <code class="docutils literal notranslate"><span class="pre">current_event_reindexing_service</span></code> proxy. This class can also be used via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">migrate</span></code> CLI command and its associated helper commands.</p>
</section>
<section id="utilities-for-generating-testing-data">
<h4>Utilities for generating testing data<a class="headerlink" href="#utilities-for-generating-testing-data" title="Link to this heading">¶</a></h4>
<p>The module includes a helper class (<code class="docutils literal notranslate"><span class="pre">UsageEventFactory</span></code>) that can be used to generate synthetic view and download events for testing.
This class can create usage events with or without the enriched metadata fields that are added to the events by the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> module, to facilitate testing of the index migration process for those usage events. This class can also be used via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">generate</span></code> CLI command and its associated helper commands.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Generated usage events cannot easily be removed without deleting the indices and losing any genuine usage events. It is therefore important not to generate these synthetic events in a production environment.</p>
</div>
</section>
</section>
<section id="presentation-layer">
<h3>Presentation layer<a class="headerlink" href="#presentation-layer" title="Link to this heading">¶</a></h3>
<p>At the presentation layer, this module provides:</p>
<ul class="simple">
<li><p>Jinja2 templates and macros to display dynamic and configurable React-based statistics dashboards</p></li>
<li><p>a Flask blueprint <code class="docutils literal notranslate"><span class="pre">invenio_stats_dashboard.blueprint</span></code> that registers view functions and routes for the global and community dashboards</p></li>
<li><p>API queries to retrieve the aggregated statistics data at the <code class="docutils literal notranslate"><span class="pre">/api/stats</span></code> endpoint managed by the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module</p></li>
</ul>
<section id="dashboard-templates">
<h4>Dashboard templates<a class="headerlink" href="#dashboard-templates" title="Link to this heading">¶</a></h4>
<p>Two templates are provided, one for the global dashboard and one for the community dashboard:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">templates/semantic-ui/invenio_stats_dashboard/stats_dashboard.html</span></code> - the global dashboard template</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">templates/semantic-ui/invenio_stats_dashboard/community_stats_dashboard.html</span></code> - the community dashboard template</p></li>
</ul>
<p>Both of these templates are essentially wrappers around the <code class="docutils literal notranslate"><span class="pre">invenio_stats_dashboard/macros/stats_dashboard_macro.html</span></code> macro, which is used to display the dashboard content.</p>
<p>The templates themselves may be overridden by providing a custom template in the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_TEMPLATES</span></code> configuration variable.</p>
</section>
<section id="views-and-routes">
<h4>Views and routes<a class="headerlink" href="#views-and-routes" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio_stats_dashboard</span></code> (in <code class="docutils literal notranslate"><span class="pre">views/views.py</span></code>) registers two view functions for the global and community dashboards:</p>
<ul class="simple">
<li><p>the global dashboard view, using the <code class="docutils literal notranslate"><span class="pre">invenio_stats_dashboard/stats_dashboard.html</span></code> template</p></li>
<li><p>the community dashboard view, using the <code class="docutils literal notranslate"><span class="pre">invenio_stats_dashboard/community_stats_dashboard.html</span></code> template</p></li>
</ul>
<p>By default, the global dashboard is registered with the <code class="docutils literal notranslate"><span class="pre">/stats</span></code> route, and the community dashboard is registered with the <code class="docutils literal notranslate"><span class="pre">/communities/&lt;community_id&gt;/stats</span></code> route. These routes can be overridden via the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_ROUTES</span></code> configuration variable.</p>
</section>
<section id="api-queries">
<h4>API queries<a class="headerlink" href="#api-queries" title="Link to this heading">¶</a></h4>
<p>The module exposes the aggregated stats at the <code class="docutils literal notranslate"><span class="pre">/api/stats</span></code> endpoint managed by the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module by adding configured queries to the <code class="docutils literal notranslate"><span class="pre">STATS_QUERIES</span></code> configuration variable.</p>
<p>Ten different queries are configured for this endpoint. Eight of these retrieve aggregated statistics from one of the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> aggregation indices:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">community-record-delta-created</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-record-delta-published</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-record-delta-added</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-record-snapshot-created</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-record-snapshot-added</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-record-snapshot-published</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-usage-delta</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-usage-snapshot</span></code></p></li>
</ul>
<p>The ninth and tenth queries, <code class="docutils literal notranslate"><span class="pre">global-stats</span></code> and <code class="docutils literal notranslate"><span class="pre">community-stats</span></code>, are composite queries that retrieve the results of the other eight queries and combines them into a single response. Both of these queries use the <code class="docutils literal notranslate"><span class="pre">CommunityStatsResultsQuery</span></code> class:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">global-stats</span></code>: calls the <code class="docutils literal notranslate"><span class="pre">CommunityStatsResultsQuery</span></code> class with the <code class="docutils literal notranslate"><span class="pre">global</span></code> community ID and passes along optional <code class="docutils literal notranslate"><span class="pre">start_date</span></code> and <code class="docutils literal notranslate"><span class="pre">end_date</span></code> parameters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community-stats</span></code>: calls the <code class="docutils literal notranslate"><span class="pre">CommunityStatsResultsQuery</span></code> class with a required <code class="docutils literal notranslate"><span class="pre">community_id</span></code> parameter (the UUID of the community for which the stats are being retrieved) as well as the optional <code class="docutils literal notranslate"><span class="pre">start_date</span></code> and <code class="docutils literal notranslate"><span class="pre">end_date</span></code> parameters.</p></li>
</ul>
<p>The following parameters are available for all of these queries:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Parameter</p></th>
<th class="head"><p>Required</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">start_date</span></code></p></td>
<td><p>No</p></td>
<td><p>The start date of the period for the desired statistics. Should be formatted as <code class="docutils literal notranslate"><span class="pre">YYYY-MM-DD</span></code>.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">end_date</span></code></p></td>
<td><p>No</p></td>
<td><p>The end date of the period for the desired statistics. Should be formatted as <code class="docutils literal notranslate"><span class="pre">YYYY-MM-DD</span></code>.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">community_id</span></code></p></td>
<td><p>Yes except for the <code class="docutils literal notranslate"><span class="pre">global-stats</span></code> query, which does not allow it</p></td>
<td><p>The UUID of the community whose stats are being retrieved.</p></td>
</tr>
</tbody>
</table>
</div>
<p>These queries can be customized by configuring the <code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_QUERIES</span></code> configuration variable.</p>
<p>The use of these endpoints is described in the <a class="reference internal" href="usage.html"><span class="doc std std-doc">Usage</span></a> section below.</p>
</section>
</section>
</section>
<section id="setup-and-migration">
<h2>Setup and Migration<a class="headerlink" href="#setup-and-migration" title="Link to this heading">¶</a></h2>
<p>In future the plan is that setup of <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> will involve simply installing the python package and restarting the InvenioRDM instance. For now, however, two initial setup tasks are required <strong>only for existing InvenioRDM instances</strong> that already have records and view/download statistics:</p>
<ul class="simple">
<li><p>index community addition events for all existing records</p></li>
<li><p>migrate the existing view and download events to the new index templates and enrich them with community and record metadata</p></li>
</ul>
<p>These tasks can be performed manually via CLI commands detailed below. They require zero downtime and can be performed in the background on a running InvenioRDM instance.</p>
<p>After these tasks are completed, the extension will be ready to use as normal. The catch-up aggregation of historical statistics will then be performed automatically as part of the scheduled aggregation tasks. Since this can, however, be a long process, especially for large instances, a utility CLI command to perform the catch-up aggregation manually is also provided.</p>
<p>So the full setup process is currently:</p>
<ol class="arabic simple">
<li><p>Install the python package</p></li>
<li><p>Set config variables for the setup period:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_TASKS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>Restart the InvenioRDM instance</p></li>
<li><p>Index community addition events for all existing records (via CLI command)</p></li>
<li><p>Migrate and enrich the existing view and download events (via CLI command)</p></li>
<li><p>OPTIONAL: Manually run the catch-up aggregation (via CLI command)</p></li>
<li><p>Set config variables for normal operation:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_TASKS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code> (if desired)</p></li>
</ul>
<ol class="arabic simple" start="8">
<li><p>Set up other configuration and community page templates as desired</p></li>
<li><p>Restart the InvenioRDM instance</p></li>
</ol>
<section id="search-index-template-registration">
<h3>Search index template registration<a class="headerlink" href="#search-index-template-registration" title="Link to this heading">¶</a></h3>
<p>If the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension is installed on a new InvenioRDM instance, the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module will automatically register the extension’s search index templates with the OpenSearch domain. But <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> does not automatically do this registration for existing InvenioRDM instances, i.e. if the main OpenSearch index setup has already been performed. So the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension will check at application startup to ensure that the extension’s search index templates are registered with the OpenSearch domain. If they are not, it registers them with the <code class="docutils literal notranslate"><span class="pre">invenio-search</span></code> module and puts them to OpenSearch. The aggregation indices will then be created automatically when the first records are indexed.</p>
<p>Registration of the expanded index templates for view and download events happens automatically as part of the usage event migration process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since the included search index tamplates all use the new-style index templates, you must ensure that STATS_REGISTER_INDEX_TEMPLATES is set to True. This is currently <em>not</em> the default for InvenioRDM instances, but it should not interfere with any other packages. The only other index templates currently registered are those from the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module, which are overridden by the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension.</p>
</div>
</section>
<section id="initial-indexing-of-community-addition-events">
<h3>Initial indexing of community addition events<a class="headerlink" href="#initial-indexing-of-community-addition-events" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> requires a dedicated search index to store data about when each record was added to or removed from a community. The <code class="docutils literal notranslate"><span class="pre">CommunityStatsService.generate_record_community_events</span></code> method will create community add/remove events for all records in the instance that do not already have events. This method can be run manually via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">generate-community-events</span></code> CLI command. For details, see the <a class="reference internal" href="#cli-commands"><span class="xref myst">CLI commands</span></a> section below.</p>
</section>
<section id="initial-migration-of-existing-view-download-events">
<h3>Initial migration of existing view/download events<a class="headerlink" href="#initial-migration-of-existing-view-download-events" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension also depends on an expanded field schema for the view and download events, adding to the core <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> schema additional fields for community and for any configured record metadata that are to be made available as subcount breakdowns in statistics.</p>
<p>A dedicated CLI command is provided to (a) register the new index templates and (b) migrate and enrich any existing view and download events. For details, see the <a class="reference internal" href="#cli-commands"><span class="xref myst">CLI commands</span></a> section below.</p>
<p>The migration and enrichment process are handled by the <code class="docutils literal notranslate"><span class="pre">EventReindexingService</span></code>. If there are no existing view or download events, the service’s <code class="docutils literal notranslate"><span class="pre">reindex_events</span></code> method will simply register the new index templates and usage events can be indexed normally. If there are existing view or download events, the <code class="docutils literal notranslate"><span class="pre">reindex_events</span></code> method will perform the following steps:</p>
<ol class="arabic simple">
<li><p>Verify that the new index templates are registered with the OpenSearch domain and register them if they are not.</p></li>
<li><p>Create new monthly view and download indices for each legacy monthly index, adding the suffix <code class="docutils literal notranslate"><span class="pre">.v2.0.0</span></code> to the index names.</p></li>
<li><p>Copy the events from the legacy monthly indices to the new monthly indices, adding the community and record metadata fields to the events.</p></li>
<li><p>Confirm that the events have all been copied over accurately.</p></li>
<li><p>Update the read aliases (<code class="docutils literal notranslate"><span class="pre">events-stats-record-view</span></code> and <code class="docutils literal notranslate"><span class="pre">events-stats-file-download</span></code>) to point to the new monthly indices.</p></li>
<li><p>Delete the legacy monthly indices for months prior to the current month (if desired).</p></li>
<li><p>Switch new event writes from the old current-month index to the new current-month index by:</p>
<ul class="simple">
<li><p>creating a temporary backup copy of the old current-month index</p></li>
<li><p>quickly deleting the old current-month index and creating a write alias to the new current-month index</p></li>
<li><p>recovering any events that arrived since the original enriched index creation from the backup index to the new enriched index</p></li>
<li><p>validating the enriched index integrity before (optionally) deleting the temporary backup index</p></li>
</ul>
</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Currently, the <code class="docutils literal notranslate"><span class="pre">EventReindexingService.reindex_events</span></code> method must be run manually to perform the migration. It can be run via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">migrate-events</span></code> CLI command and its associated helper commands. In future, the migration will be integrated automatically as part of the scheduled aggregation tasks, to be completed in the background over a series of scheduled runs before the first aggregations are actually performed.</p>
</div>
<p>TODO: set up check and automatic migration in aggregator tasks</p>
<section id="preventing-overload-of-opensearch-or-memory">
<h4>Preventing overload of OpenSearch or memory<a class="headerlink" href="#preventing-overload-of-opensearch-or-memory" title="Link to this heading">¶</a></h4>
<p>The reindexing service is configured to run in batches, to avoid overwhelming the OpenSearch domain with too many concurrent requests. The batch size and maximum number of batches can be configured via the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_BATCH_SIZE</span></code> and <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_BATCHES</span></code> configuration variables.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>OpenSearch has a hard limit of 10,000 documents for search results. This means <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_BATCH_SIZE</span></code> cannot exceed 10,000, and any attempt to count documents after a search_after position will be limited to 10,000 results maximum.</p>
</div>
<p>The service will also check the memory usage of the OpenSearch domain on starting each batch and exit if the memory usage exceeds the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_MEMORY_PERCENT</span></code> configuration variable. The service will also check the health of the OpenSearch domain on starting each batch and exit if the health is not good.</p>
</section>
<section id="handling-failures">
<h4>Handling failures<a class="headerlink" href="#handling-failures" title="Link to this heading">¶</a></h4>
<p>If the reindexing of a particular month fails, the service will leave the original index in place and continue with the next month. It will log a warning and report the failure in the service’s output report. The service will reset that index’s bookmark to the beginning and try to reindex the month again on the next run. Alternately, you may manually retry the migration of a particular month by running the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">migrate</span></code> CLI command with its <code class="docutils literal notranslate"><span class="pre">--months</span></code> option set to the month in question and its <code class="docutils literal notranslate"><span class="pre">--event-types</span></code> option set to the event type in question.</p>
<p>For more information about failed migrations and how to retry them, you can use the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">status</span></code> CLI command.</p>
</section>
<section id="handling-progress-across-migration-runs">
<h4>Handling progress across migration runs<a class="headerlink" href="#handling-progress-across-migration-runs" title="Link to this heading">¶</a></h4>
<p>If the service hits the maximum number of batches before a monthly index is completely migrated, it will log a warning and report the progress in the service’s output report. The service will set a bookmark to record the last processed event id, so that the next reindexing service run can continue from that point. These bookmarks are stored in the <code class="docutils literal notranslate"><span class="pre">stats-community-events-reindexing</span></code> index and are set independently for each monthly index.</p>
<p>If you wish to clear the bookmarks for a particular month, you can use the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">clear-bookmarks</span></code> CLI command with its <code class="docutils literal notranslate"><span class="pre">--months</span></code> option set to the month in question, and its <code class="docutils literal notranslate"><span class="pre">--event-types</span></code> option set to the event type in question, and the <code class="docutils literal notranslate"><span class="pre">--fresh-start</span></code> flag.</p>
<p>To clear the bookmarks for all months, you can use the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">clear-bookmarks</span></code> CLI command.</p>
</section>
</section>
<section id="initial-aggregation-of-historical-data">
<h3>Initial aggregation of historical data<a class="headerlink" href="#initial-aggregation-of-historical-data" title="Link to this heading">¶</a></h3>
<p>The extension will perform the initial aggregation of historical statistics automatically as part of the scheduled aggregation tasks. This can be a long process, especially for large instances, so a utility CLI command to perform the catch-up aggregation manually is also provided. This gives the instance maintainer more control over the process and can still run in the background while the instance is in use. For details, see the <a class="reference internal" href="#cli-commands"><span class="xref myst">CLI commands</span></a> section below.</p>
</section>
</section>
<section id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Link to this heading">¶</a></h2>
<p>The module provides:</p>
<section id="blueprints-and-routes">
<h3>Blueprints and routes<a class="headerlink" href="#blueprints-and-routes" title="Link to this heading">¶</a></h3>
<p>The module provides a blueprint <code class="docutils literal notranslate"><span class="pre">invenio_stats_dashboard.blueprint</span></code> that is registered with the following routes:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/stats</span></code> - the global dashboard.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/communities/&lt;community_id&gt;/stats</span></code> - the community dashboard.</p></li>
</ul>
<p>These default routes are set via the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_ROUTES</span></code> configuration variable and can be overridden.</p>
</section>
<section id="jinja2-templates">
<h3>Jinja2 templates<a class="headerlink" href="#jinja2-templates" title="Link to this heading">¶</a></h3>
</section>
<section id="enabling-the-global-dashboard-template">
<h3>Enabling the global dashboard template<a class="headerlink" href="#enabling-the-global-dashboard-template" title="Link to this heading">¶</a></h3>
<p>A Jinja2 template for the global dashboard, registered as a top-level page template at the global stats dashboard route (<code class="docutils literal notranslate"><span class="pre">/stats</span></code> by default). A top-level menu item is registered for this template by default, but can be disabled by setting the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ENABLED</span></code> configuration variable to <code class="docutils literal notranslate"><span class="pre">False</span></code>. The text and position of the menu item can be configured via config variables. Alternately, a custom function can be provided to register the menu item (See <a class="reference internal" href="configuration.html"><span class="doc std std-doc">Configuration</span></a> below for more information.)</p>
</section>
<section id="enabling-the-community-dashboard-template">
<h3>Enabling the community dashboard template<a class="headerlink" href="#enabling-the-community-dashboard-template" title="Link to this heading">¶</a></h3>
<p>A Jinja2 template for the community dashboard page content, intended to be used as a sub-page of the community details page. This is registered with the community stats dashboard route (<code class="docutils literal notranslate"><span class="pre">/communities/&lt;community_id&gt;/stats</span></code> by default).</p>
<p>To implement this in your community details page, you can add a menu tab to the community details page template linking to this template route.</p>
</section>
<section id="customizing-the-layout-of-your-dashboard">
<h3>Customizing the layout of your dashboard<a class="headerlink" href="#customizing-the-layout-of-your-dashboard" title="Link to this heading">¶</a></h3>
<p>The layout and pagination of the stats dashboards is intended to be highly customizable via
the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_LAYOUT</span></code> configuration variable. This is a dictionary that maps dashboard types (currently <code class="docutils literal notranslate"><span class="pre">global</span></code> and <code class="docutils literal notranslate"><span class="pre">community</span></code> are available) to layout configurations. Each layout configuration is a dictionary that maps dashboard sections to a list of components to display in that section.</p>
<ul class="simple">
<li><p>Tabs can be specified to group dashboard pages, navigated between using a menu at the side</p></li>
<li><p>Rows can be specified to group components together, and component widths can be specified with a “width” key.</p></li>
<li><p>Individual components of the layout are React components that are configurable via the <code class="docutils literal notranslate"><span class="pre">props</span></code> key.</p>
<ul>
<li><p>specify, e.g., the title, number of items to display in the view, etc.</p></li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The plan is to provide a way to register additional React components via an entry point, so that they can be used in the layout configuration.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We will also be using ReactOverridable to allow overriding of the default React components. This will include the overall dashboard frame layout (with menu, sidebar, and main content areas) as well as individual metrics components.</p>
</div>
<section id="layout-configuration-structure">
<h4>Layout Configuration Structure<a class="headerlink" href="#layout-configuration-structure" title="Link to this heading">¶</a></h4>
<p>The <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_LAYOUT</span></code> configuration follows this structure:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_LAYOUT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;tabs&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tab_identifier&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Tab Display Name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="s2">&quot;semantic-ui-icon-name&quot;</span><span class="p">,</span>
                <span class="s2">&quot;date_range_phrase&quot;</span><span class="p">:</span> <span class="s2">&quot;Date range description&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;row_identifier&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;ComponentName&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>  <span class="c1"># Grid width (1-16)</span>
                                <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Component Title&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
                                    <span class="s2">&quot;pageSize&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                                    <span class="c1"># ... other component-specific props</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="available-components">
<h4>Available Components<a class="headerlink" href="#available-components" title="Link to this heading">¶</a></h4>
<p>The dashboard supports several categories of components:</p>
<p><strong>Single Statistics Components:</strong></p>
<p>These are single numerical metrics much like the ones provided at the top of the default record stats display for view and download counts.</p>
<p>Several built-in single-statistic components give numerical counts for some metric during a given period of time. The time period is dictated by the dashboard global date range selector.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatRecordCount</span></code> - Number of records added during a period</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatUploaders</span></code> - Number of active uploaders during a period</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatDataVolume</span></code> - Volume of downloaded data during a period</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatViews</span></code> - Number of unique views during a period</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatDownloads</span></code> - Number of unique downloads during a period</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatTraffic</span></code> - Volume of data downloaded during a period</p></li>
</ul>
<p>The other category of built-in single-statistic components give cumulative totals for some metric by a given date. The date is the end point of the range selected in the dashboard global date range selector.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatRecordCountCumulative</span></code> - Cumulative total number of records added by a given date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatUploadersCumulative</span></code> - Cumulative total number of unique uploaders by a date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatDataVolumeCumulative</span></code> - Cumulative total volume of downloaded data by a given date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatViewsCumulative</span></code> - Cumulative total number of unique views by a given date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatDownloadsCumulative</span></code> - Cumulative total number of unique downloads by a given date</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SingleStatTrafficCumulative</span></code> - Cumulative total volume of data downloaded by a given date</p></li>
</ul>
<p>Both categories of single-statistic components all inherit from the abstract <code class="docutils literal notranslate"><span class="pre">SingleStatBox</span></code> component, which can be used to construct other single-statistic components.</p>
<p><strong>Chart Components:</strong></p>
<p>These are bar or line charts (rendered by Apache ECharts) that show time series data. The time period is dictated by the dashboard global date range selector. The granularity of the data points displayed (day, week, month, quarter, year) is dictated by the dashboard global granularity selector.</p>
<p>The default charts visualize the four different types of aggregation series:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ContentStatsChart</span></code> - Daily record deltas (additional records, files, uploaders, and data volume during each period)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ContentStatsChartCumulative</span></code> - Daily record snapshots (cumulative totals of records, files, uploaders, and data volume as of each date)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TrafficStatsChart</span></code> - Usage deltas (additional views, downloads, and data volume each period)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TrafficStatsChartCumulative</span></code> - Usage snapshots (cumulative totals of views, downloads, and data volume as of each date)</p></li>
</ul>
<p>The “display separately” filter in each one can be configured to allow dynamic display of any breakdown configured for the extension. We could allow only breakdowns by resource type, file type, and funder, for example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;ContentStatsChart&quot;</span><span class="p">,</span>
    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">300</span><span class="p">,</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Cumulative Content Totals&quot;</span><span class="p">,</span>
        <span class="s2">&quot;display_subcounts&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;by_resource_types&quot;</span><span class="p">,</span> <span class="s2">&quot;by_file_types&quot;</span><span class="p">,</span> <span class="s2">&quot;by_funders&quot;</span><span class="p">],</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>These all inherit from the abstract <code class="docutils literal notranslate"><span class="pre">StatsChart</span></code> component, which can be used to construct other chart components.</p>
<p><strong>Multi-Display Components:</strong></p>
<p>The multi-display components show a single metric broken down by one of the configured subcount types (e.g., top resource types by cumulative record count, top subjects by views during a period, etc.). They display as a box with a title, icon, and controls to switch the visualization type on the fly. The available visualization types are:</p>
<ul class="simple">
<li><p>text table</p></li>
<li><p>pie chart</p></li>
<li><p>bar chart</p></li>
</ul>
<p>The default visualization type, as well as which visualization types are available, can be configured separately for each multi-display component via component props. For example, I could specify in my layout that I want to display the top resource types by cumulative record count, with:</p>
<ul class="simple">
<li><p>the pie chart as the default visualization type</p></li>
<li><p>only the table as an alternate available visualization type (hiding the bar chart option)</p></li>
<li><p>displaying only the top 10 items</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;ResourceTypesMultiDisplay&quot;</span><span class="p">,</span>
    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
    <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Top Resource Types&quot;</span><span class="p">,</span>
        <span class="s2">&quot;pageSize&quot;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
        <span class="s2">&quot;available_views&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">],</span>
        <span class="s2">&quot;default_view&quot;</span><span class="p">:</span> <span class="s2">&quot;pie&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If I wish to display just one visualization type, with no selection controls, I can set the <code class="docutils literal notranslate"><span class="pre">available_views</span></code> prop to an array containing only the desired visualization type.</p>
<p>Currently, all of the build-in multi-display components provide counts <em>for the period selected in the dashboard global date range selector</em>. We plan to add multi-display components that provide cumulative totals <em>as of the end of the range selected in the dashboard global date range selector</em>.</p>
<p>Several of the built-in multi-display components are offer record counts broken down by a metadata field:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ResourceTypesMultiDisplay</span></code> - Record counts by resource type</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">SubjectsMultiDisplay</span></code> - Record counts by subject</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AccessStatusesMultiDisplay</span></code> - Record counts by access status</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">RightsMultiDisplay</span></code> - Record counts by rights/licenses</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">AffiliationsMultiDisplay</span></code> - Record counts by affiliation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FundersMultiDisplay</span></code> - Record counts by funder</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PeriodicalsMultiDisplay</span></code> - Record counts by periodical</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">PublishersMultiDisplay</span></code> - Record counts by publisher</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TopLanguagesMultiDisplay</span></code> - Record counts by language</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">FileTypesMultiDisplay</span></code> - Record counts by file type</p></li>
</ul>
<p>Other built-in multi-display components offer top lists of values broken down by view or download event data:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">TopCountriesMultiDisplay</span></code> - Top countries by visits</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">TopReferrersMultiDisplay</span></code> - Top referrer domains</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MostDownloadedRecordsMultiDisplay</span></code> - Most downloaded records</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">MostViewedRecordsMultiDisplay</span></code> - Most viewed records</p></li>
</ul>
<p><strong>Map Components:</strong></p>
<p>A map component is also available to display the geographic distribution of record viewers:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">StatsMap</span></code> - Interactive world map showing geographic distribution</p></li>
</ul>
<p>This can be added to the layout like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;StatsMap&quot;</span><span class="p">,</span>
    <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
    <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Top Countries by Visits&quot;</span><span class="p">,</span>
        <span class="s2">&quot;height&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
        <span class="s2">&quot;minHeight&quot;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
        <span class="s2">&quot;zoom&quot;</span><span class="p">:</span> <span class="mf">1.3</span><span class="p">,</span>
        <span class="s2">&quot;center&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">],</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The plan is to add an additional map component to display the geographic distribution of downloaders.</p>
</section>
<section id="component-properties">
<h4>Component Properties<a class="headerlink" href="#component-properties" title="Link to this heading">¶</a></h4>
<p>Each component accepts various properties through the <code class="docutils literal notranslate"><span class="pre">props</span></code> dictionary:</p>
<p><strong>Common Properties:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">title</span></code> - Display title for the component</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">height</span></code> - Component height in pixels</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">pageSize</span></code> - Number of items to display per page (for tables/lists)</p></li>
</ul>
<p><strong>Chart-Specific Properties:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">display_subcounts</span></code> - Array of subcount types to display (e.g., <code class="docutils literal notranslate"><span class="pre">[&quot;by_resource_types&quot;,</span> <span class="pre">&quot;by_subjects&quot;]</span></code>)</p></li>
</ul>
<p><strong>Multi-Display Properties:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">available_views</span></code> - Array of available view types: <code class="docutils literal notranslate"><span class="pre">[&quot;pie&quot;,</span> <span class="pre">&quot;bar&quot;,</span> <span class="pre">&quot;list&quot;]</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_view</span></code> - Default view type to display</p></li>
</ul>
<p><strong>Map-Specific Properties:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">minHeight</span></code> - Minimum height for the map</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">zoom</span></code> - Initial zoom level</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">center</span></code> - Map center coordinates <code class="docutils literal notranslate"><span class="pre">[latitude,</span> <span class="pre">longitude]</span></code></p></li>
</ul>
</section>
</section>
<section id="global-ui-configuration">
<h3>Global UI Configuration<a class="headerlink" href="#global-ui-configuration" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_UI_CONFIG</span></code> variable controls dashboard-wide settings:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_UI_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Statistics&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Dashboard description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxHistoryYears&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s2">&quot;default_granularity&quot;</span><span class="p">:</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span>
        <span class="s2">&quot;show_title&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;show_description&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;community&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Community Statistics&quot;</span><span class="p">,</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="s2">&quot;Community dashboard description&quot;</span><span class="p">,</span>
        <span class="s2">&quot;maxHistoryYears&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s2">&quot;default_granularity&quot;</span><span class="p">:</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span>
        <span class="s2">&quot;show_title&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;show_description&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>UI Configuration Parameters:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">title</span></code> - Dashboard title</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">description</span></code> - Dashboard description text</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">maxHistoryYears</span></code> - Maximum number of years of historical data that can be selected for view</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">default_granularity</span></code> - Default time granularity (<code class="docutils literal notranslate"><span class="pre">&quot;day&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;week&quot;</span></code>, <code class="docutils literal notranslate"><span class="pre">&quot;month&quot;</span></code>) to display in the date range selector when the dashboard is first loaded</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">show_title</span></code> - Whether to display the dashboard title</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">show_description</span></code> - Whether to display the dashboard description</p></li>
</ul>
<section id="customization-examples">
<h4>Customization Examples<a class="headerlink" href="#customization-examples" title="Link to this heading">¶</a></h4>
<p><strong>Example 1: Custom Global Dashboard Layout</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_LAYOUT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;tabs&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;overview&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Overview&quot;</span><span class="p">,</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="s2">&quot;chart bar&quot;</span><span class="p">,</span>
                <span class="s2">&quot;date_range_phrase&quot;</span><span class="p">:</span> <span class="s2">&quot;Data as of&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;key-metrics&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatRecordCountCumulative&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                                <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Total Records&quot;</span><span class="p">,</span> <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="s2">&quot;file&quot;</span><span class="p">}</span>
                            <span class="p">},</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatViewsCumulative&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
                                <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Total Views&quot;</span><span class="p">,</span> <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="s2">&quot;eye&quot;</span><span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">]</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;content-breakdown&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;ResourceTypesMultiDisplay&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                                <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Content by Type&quot;</span><span class="p">,</span>
                                    <span class="s2">&quot;pageSize&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
                                    <span class="s2">&quot;available_views&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;pie&quot;</span><span class="p">,</span> <span class="s2">&quot;bar&quot;</span><span class="p">,</span> <span class="s2">&quot;list&quot;</span><span class="p">],</span>
                                    <span class="s2">&quot;default_view&quot;</span><span class="p">:</span> <span class="s2">&quot;pie&quot;</span>
                                <span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example 2: Community Dashboard Layout</strong></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_LAYOUT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;community&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;tabs&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;community-stats&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Community Statistics&quot;</span><span class="p">,</span>
                <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span>
                <span class="s2">&quot;date_range_phrase&quot;</span><span class="p">:</span> <span class="s2">&quot;Community activity during&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;metrics&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span>
                                <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatRecordCount&quot;</span><span class="p">,</span>
                                <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">,</span>
                                <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Records Added&quot;</span><span class="p">,</span> <span class="s2">&quot;icon&quot;</span><span class="p">:</span> <span class="s2">&quot;plus&quot;</span><span class="p">}</span>
                            <span class="p">}</span>
                        <span class="p">]</span>
                    <span class="p">}</span>
                <span class="p">]</span>
            <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p><strong>Example 3: Customizing Component Widths</strong></p>
<p>Components use a 16-column grid system. You can control layout by adjusting widths:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatRecordCount&quot;</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># Takes 1/4 of the row</span>
        <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Records&quot;</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatViews&quot;</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>  <span class="c1"># Takes 1/2 of the row</span>
        <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Views&quot;</span><span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
        <span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatDownloads&quot;</span><span class="p">,</span>
        <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>  <span class="c1"># Takes 1/4 of the row</span>
        <span class="s2">&quot;props&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="s2">&quot;Downloads&quot;</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">]</span>
</pre></div>
</div>
</section>
</section>
<section id="adding-dashboard-views-to-other-pages">
<h3>Adding dashboard views to other pages<a class="headerlink" href="#adding-dashboard-views-to-other-pages" title="Link to this heading">¶</a></h3>
<p>The default global and community dashboard templates are based on a Jinja2 template macro that can also be included in other templates to display an embedded dashboard view:</p>
<div class="highlight-html notranslate"><div class="highlight"><pre><span></span>{%- extends &quot;invenio_theme/page.html&quot; %}
{%- import &quot;invenio_stats_dashboard/stats_dashboard.html&quot; as stats_dashboard %}

{%- block page_body %}
  {{ stats_dashboard.stats_dashboard(dashboard_config, community=community) }}
{%- endblock %}
</pre></div>
</div>
<p>The macro takes the following parameters:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">dashboard_config</span></code>: The configuration for the dashboard. This is a dictionary that maps dashboard types (currently <code class="docutils literal notranslate"><span class="pre">global</span></code> and <code class="docutils literal notranslate"><span class="pre">community</span></code>) to layout configurations.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">community</span></code>: The community to display the dashboard for (if <code class="docutils literal notranslate"><span class="pre">dashboard_type</span></code> is <code class="docutils literal notranslate"><span class="pre">community</span></code>). [Optional. Defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code>, which will display the global dashboard].</p></li>
</ul>
</section>
</section>
<section id="configuration">
<h2>Configuration<a class="headerlink" href="#configuration" title="Link to this heading">¶</a></h2>
<section id="configuration-overrides">
<h3>Configuration Overrides<a class="headerlink" href="#configuration-overrides" title="Link to this heading">¶</a></h3>
<p>The default configuration values are defined in the module’s <code class="docutils literal notranslate"><span class="pre">config.py</span></code> file. These defaults can be overridden in the top-level <code class="docutils literal notranslate"><span class="pre">invenio.cfg</span></code> file of
an InvenioRDM instance or as environment variables.</p>
</section>
<section id="module-enable-disable">
<h3>Module Enable/Disable<a class="headerlink" href="#module-enable-disable" title="Link to this heading">¶</a></h3>
<p>The entire community stats dashboard module can be enabled or disabled using the <code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_ENABLED</span></code> configuration variable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Disable the module completely</span>
<span class="n">COMMUNITY_STATS_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>When disabled:</p>
<ul class="simple">
<li><p><strong>Scheduled tasks will not run</strong>: No automatic aggregation or migration tasks</p></li>
<li><p><strong>CLI commands will fail</strong>: All commands will show an error message</p></li>
<li><p><strong>Services will not be initialized</strong>: No event tracking or statistics services</p></li>
<li><p><strong>Menus will not be registered</strong>: No dashboard menu items</p></li>
<li><p><strong>Components will not be added</strong>: No event tracking components</p></li>
</ul>
<p><strong>Note</strong>: This is a global on/off switch. When disabled, the module will not modify the instance in any way.</p>
</section>
<section id="scheduled-tasks-enable-disable">
<h3>Scheduled Tasks Enable/Disable<a class="headerlink" href="#scheduled-tasks-enable-disable" title="Link to this heading">¶</a></h3>
<p>Scheduled aggregation tasks can be controlled separately using the <code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_TASKS_ENABLED</span></code> configuration variable:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enable the module but disable scheduled tasks</span>
<span class="n">COMMUNITY_STATS_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">COMMUNITY_STATS_SCHEDULED_TASKS_ENABLED</span> <span class="o">=</span> <span class="kc">False</span>
</pre></div>
</div>
<p>When scheduled tasks are disabled:</p>
<ul class="simple">
<li><p><strong>Scheduled aggregation tasks will not run</strong>: No automatic daily/weekly aggregation</p></li>
<li><p><strong>CLI aggregation commands will fail</strong>: <code class="docutils literal notranslate"><span class="pre">aggregate-stats</span></code> command will show an error</p></li>
<li><p><strong>Manual aggregation still works</strong>: You can still run aggregation manually via Celery tasks</p></li>
<li><p><strong>All other functionality remains</strong>: Event tracking, migration, and other features work normally</p></li>
</ul>
<p>This allows you to enable the module for manual operations while preventing automatic background tasks.</p>
</section>
<section id="view-download-event-migration">
<h3>View/Download event migration<a class="headerlink" href="#view-download-event-migration" title="Link to this heading">¶</a></h3>
<p>The following configuration variables control the default behavior of migration commands:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_REINDEXING_MAX_BATCHES</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Maximum number of batches to process per month</span>
<span class="n">STATS_DASHBOARD_REINDEXING_BATCH_SIZE</span> <span class="o">=</span> <span class="mi">1000</span>  <span class="c1"># Number of events to process per batch</span>
<span class="n">STATS_DASHBOARD_REINDEXING_MAX_MEMORY_PERCENT</span> <span class="o">=</span> <span class="mi">75</span>  <span class="c1"># Maximum memory usage percentage before stopping</span>
</pre></div>
</div>
<p>These defaults can be overridden using the corresponding CLI options when running the <code class="docutils literal notranslate"><span class="pre">migrate-events</span></code> command.</p>
</section>
<section id="task-scheduling-and-aggregation">
<h3>Task scheduling and aggregation<a class="headerlink" href="#task-scheduling-and-aggregation" title="Link to this heading">¶</a></h3>
<p>The following configuration variables control the scheduling and behavior of aggregation tasks:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">invenio_stats_dashboard.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">CommunityStatsAggregationTask</span>

<span class="n">COMMUNITY_STATS_CELERYBEAT_SCHEDULE</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;stats-aggregate-community-record-stats&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="o">**</span><span class="n">CommunityStatsAggregationTask</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
<span class="sd">&quot;&quot;&quot;Celery beat schedule for aggregation tasks.&quot;&quot;&quot;</span>

<span class="n">COMMUNITY_STATS_CATCHUP_INTERVAL</span> <span class="o">=</span> <span class="mi">365</span>
<span class="sd">&quot;&quot;&quot;Maximum number of days to catch up when aggregating historical data.&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="aggregation-task-locking">
<h3>Aggregation task locking<a class="headerlink" href="#aggregation-task-locking" title="Link to this heading">¶</a></h3>
<p>The following configuration variables control the locking mechanism for the aggregation task:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_LOCK_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;enabled&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Enable/disable distributed locking</span>
    <span class="s2">&quot;lock_timeout&quot;</span><span class="p">:</span> <span class="mi">86400</span><span class="p">,</span>  <span class="c1"># Lock timeout in seconds (24 hours)</span>
    <span class="s2">&quot;lock_name&quot;</span><span class="p">:</span> <span class="s2">&quot;community_stats_aggregation&quot;</span><span class="p">,</span>  <span class="c1"># Lock name</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="default-range-options">
<h3>Default range options<a class="headerlink" href="#default-range-options" title="Link to this heading">¶</a></h3>
<p>The following configuration variable controls the default date range options for the dashboard. The keys represent the
available granularity levels for the date range selector and cannot be changed. The values represent the default date
range for each granularity level.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_DEFAULT_RANGE_OPTIONS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;day&quot;</span><span class="p">:</span> <span class="s2">&quot;30days&quot;</span><span class="p">,</span>
    <span class="s2">&quot;week&quot;</span><span class="p">:</span> <span class="s2">&quot;12weeks&quot;</span><span class="p">,</span>
    <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="s2">&quot;12months&quot;</span><span class="p">,</span>
    <span class="s2">&quot;quarter&quot;</span><span class="p">:</span> <span class="s2">&quot;4quarters&quot;</span><span class="p">,</span>
    <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="s2">&quot;5years&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="menu-configuration">
<h3>Menu configuration<a class="headerlink" href="#menu-configuration" title="Link to this heading">¶</a></h3>
<p>The following configuration variables control the menu integration for the global dashboard:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_MENU_ENABLED</span> <span class="o">=</span> <span class="kc">True</span>
<span class="sd">&quot;&quot;&quot;Enable or disable the stats menu item.&quot;&quot;&quot;</span>

<span class="n">STATS_DASHBOARD_MENU_TEXT</span> <span class="o">=</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Statistics&quot;</span><span class="p">)</span>
<span class="sd">&quot;&quot;&quot;Text for the stats menu item.&quot;&quot;&quot;</span>

<span class="n">STATS_DASHBOARD_MENU_ORDER</span> <span class="o">=</span> <span class="mi">1</span>
<span class="sd">&quot;&quot;&quot;Order of the stats menu item in the menu.&quot;&quot;&quot;</span>

<span class="n">STATS_DASHBOARD_MENU_ENDPOINT</span> <span class="o">=</span> <span class="s2">&quot;invenio_stats_dashboard.global_stats_dashboard&quot;</span>
<span class="sd">&quot;&quot;&quot;Endpoint for the stats menu item.&quot;&quot;&quot;</span>

<span class="n">STATS_DASHBOARD_MENU_REGISTRATION_FUNCTION</span> <span class="o">=</span> <span class="kc">None</span>
<span class="sd">&quot;&quot;&quot;Custom function to register the menu item. If None, uses default registration.</span>
<span class="sd">Should be a callable that takes the Flask app as its only argument.&quot;&quot;&quot;</span>
</pre></div>
</div>
</section>
<section id="dashboard-layout-and-components">
<h3>Dashboard layout and components<a class="headerlink" href="#dashboard-layout-and-components" title="Link to this heading">¶</a></h3>
<p>The layout and components for the dashboard are configured via the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_LAYOUT</span></code> configuration variable. This is a dictionary that maps dashboard types (currently <code class="docutils literal notranslate"><span class="pre">global</span></code> and <code class="docutils literal notranslate"><span class="pre">community</span></code>) to layout configurations. Each layout configuration is a dictionary that maps dashboard sections to a list of components to display in that section. Rows can be specified to group components together, and component widths can be specified with a “width” key.</p>
<p>For example, the default global layout configuration is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_LAYOUT</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;tabs&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;content&quot;</span><span class="p">,</span>
                <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Content&quot;</span><span class="p">,</span>
                <span class="s2">&quot;rows&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;date-range-selector&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;DateRangeSelector&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">16</span><span class="p">}],</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;single-stats&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatRecordCount&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatUploaders&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;SingleStatDataVolume&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;charts&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;StatsChart&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;tables&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;components&quot;</span><span class="p">:</span> <span class="p">[</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;ResourceTypesTable&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;AccessStatusTable&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;RightsTable&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                            <span class="p">{</span><span class="s2">&quot;component&quot;</span><span class="p">:</span> <span class="s2">&quot;AffiliationsTable&quot;</span><span class="p">,</span> <span class="s2">&quot;width&quot;</span><span class="p">:</span> <span class="mi">8</span><span class="p">},</span>
                        <span class="p">],</span>
                    <span class="p">},</span>
                <span class="p">],</span>
            <span class="p">},</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If no layout configuration is provided for a dashboard type, the default “global” layout configuration will be used.</p>
<p>Any additional key/value pairs in the dictionary for a component will be passed to the component class as additional props. This allows for some customization of the component without having to subclass and override the component class.</p>
<p>The component labels used for the layout configuration are defined in the <code class="docutils literal notranslate"><span class="pre">components_map.js</span></code> file, where they are mapped to the component classes.</p>
</section>
<section id="routes">
<h3>Routes<a class="headerlink" href="#routes" title="Link to this heading">¶</a></h3>
<p>The routes for the dashboard are defined by the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_ROUTES</span></code> configuration variable. This is a dictionary that maps dashboard types (currently <code class="docutils literal notranslate"><span class="pre">global</span></code> and <code class="docutils literal notranslate"><span class="pre">community</span></code>) to route strings.</p>
<p>For example, the default routes are:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_ROUTES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="s2">&quot;/stats&quot;</span><span class="p">,</span>
    <span class="s2">&quot;community&quot;</span><span class="p">:</span> <span class="s2">&quot;/communities/&lt;community_id&gt;/stats&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="templates">
<h3>Templates<a class="headerlink" href="#templates" title="Link to this heading">¶</a></h3>
<p>The templates for the dashboard are defined by the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_TEMPLATES</span></code> configuration variable. This is a dictionary that maps dashboard types (currently <code class="docutils literal notranslate"><span class="pre">global</span></code> and <code class="docutils literal notranslate"><span class="pre">community</span></code>) to template strings.</p>
<p>For example, the default templates are:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_TEMPLATES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;macro&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats_dashboard/macros/stats_dashboard_macro.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats_dashboard/stats_dashboard.html&quot;</span><span class="p">,</span>
    <span class="s2">&quot;community&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats_dashboard/community_stats_dashboard.html&quot;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="ui-configuration">
<h3>UI Configuration<a class="headerlink" href="#ui-configuration" title="Link to this heading">¶</a></h3>
<p>The UI configuration for the dashboard is defined by the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_UI_CONFIG</span></code> configuration variable. This is a dictionary that maps dashboard types (currently <code class="docutils literal notranslate"><span class="pre">global</span></code> and <code class="docutils literal notranslate"><span class="pre">community</span></code>) to a dictionary of configuration options.</p>
<p>For example, the default UI configuration is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_UI_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;global&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Statistics&quot;</span><span class="p">),</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This is the global stats dashboard.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;maxHistoryYears&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s2">&quot;default_granularity&quot;</span><span class="p">:</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span>
        <span class="s2">&quot;show_title&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;show_description&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;community&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;Statistics&quot;</span><span class="p">),</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s2">&quot;This is the community stats dashboard.&quot;</span><span class="p">),</span>
        <span class="s2">&quot;maxHistoryYears&quot;</span><span class="p">:</span> <span class="mi">15</span><span class="p">,</span>
        <span class="s2">&quot;default_granularity&quot;</span><span class="p">:</span> <span class="s2">&quot;month&quot;</span><span class="p">,</span>
        <span class="s2">&quot;show_title&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s2">&quot;show_description&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
<section id="title-and-description-display">
<h4>Title and description display<a class="headerlink" href="#title-and-description-display" title="Link to this heading">¶</a></h4>
<p>The title and description display in different places for the global and community dashboards. For the global dashboard, the title and description are displayed in the page subheader, while for the community dashboard they display at the top of the dashboard sidebar.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">show_title</span></code> and <code class="docutils literal notranslate"><span class="pre">show_description</span></code> options can be used to control whether the title and description are displayed for the global and community dashboards.</p>
</section>
</section>
<section id="subcount-configuration">
<h3>Subcount Configuration<a class="headerlink" href="#subcount-configuration" title="Link to this heading">¶</a></h3>
<p>The following configuration variables control how subcount breakdowns are generated and displayed:</p>
<section id="community-stats-top-subcount-limit">
<h4><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT</span></code><a class="headerlink" href="#community-stats-top-subcount-limit" title="Link to this heading">¶</a></h4>
<p>This variable controls the maximum number of items returned in subcount breakdowns (e.g., “Top 20 Resource Types”). This helps prevent overwhelming the UI with too many items and improves performance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT</span> <span class="o">=</span> <span class="mi">20</span>
</pre></div>
</div>
</section>
<section id="community-stats-subcount-configs">
<h4><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SUBCOUNT_CONFIGS</span></code><a class="headerlink" href="#community-stats-subcount-configs" title="Link to this heading">¶</a></h4>
<p>This variable defines the configuration for different subcount breakdown types, including field mappings and display options.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">COMMUNITY_STATS_SUBCOUNT_CONFIGS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;by_resource_types&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;metadata.resource_type.id&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Resource Type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;display_field&quot;</span><span class="p">:</span> <span class="s2">&quot;metadata.resource_type.title&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;by_subjects&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="s2">&quot;metadata.subjects.subject&quot;</span><span class="p">,</span>
        <span class="s2">&quot;label&quot;</span><span class="p">:</span> <span class="s2">&quot;Subject&quot;</span><span class="p">,</span>
        <span class="s2">&quot;display_field&quot;</span><span class="p">:</span> <span class="s2">&quot;metadata.subjects.subject&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="c1"># ... other subcount configurations</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="stats-dashboard-ui-subcounts">
<h4><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_UI_SUBCOUNTS</span></code><a class="headerlink" href="#stats-dashboard-ui-subcounts" title="Link to this heading">¶</a></h4>
<p>This variable controls which subcount breakdowns are available in the UI and how they are displayed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_UI_SUBCOUNTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;by_resource_types&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_subjects&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_languages&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_rights&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_funders&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_periodicals&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_publishers&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_affiliations&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;combine&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;by_affiliations_creator&quot;</span><span class="p">,</span> <span class="s2">&quot;by_affiliations_contributor&quot;</span><span class="p">]</span>
    <span class="p">},</span>
    <span class="s2">&quot;by_countries&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_referrers&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_file_types&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;by_access_statuses&quot;</span><span class="p">:</span> <span class="p">{},</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="test-data-mode">
<h3>Test Data Mode<a class="headerlink" href="#test-data-mode" title="Link to this heading">¶</a></h3>
<section id="stats-dashboard-use-test-data">
<h4><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_USE_TEST_DATA</span></code><a class="headerlink" href="#stats-dashboard-use-test-data" title="Link to this heading">¶</a></h4>
<p>This variable enables test data mode for development and testing purposes. When enabled, the dashboard will use synthetic data instead of making API calls to the statistics service.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_DASHBOARD_USE_TEST_DATA</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p><strong>Note</strong>: This should be set to <code class="docutils literal notranslate"><span class="pre">False</span></code> in production environments to ensure real statistics data is displayed.</p>
</section>
</section>
<section id="event-processing-configuration">
<h3>Event Processing Configuration<a class="headerlink" href="#event-processing-configuration" title="Link to this heading">¶</a></h3>
<section id="stats-events">
<h4><code class="docutils literal notranslate"><span class="pre">STATS_EVENTS</span></code><a class="headerlink" href="#stats-events" title="Link to this heading">¶</a></h4>
<p>This variable defines the event types and their configurations for statistics processing. It controls which events are tracked and how they are processed.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">STATS_EVENTS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;file-download&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats.processors.flag_robots&quot;</span><span class="p">,</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats.processors.flag_machines&quot;</span><span class="p">,</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats.processors.anonymize_user&quot;</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="s2">&quot;record-view&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats.processors.flag_robots&quot;</span><span class="p">,</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats.processors.flag_machines&quot;</span><span class="p">,</span>
        <span class="s2">&quot;processor&quot;</span><span class="p">:</span> <span class="s2">&quot;invenio_stats.processors.anonymize_user&quot;</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="auto-generated-configuration">
<h3>Auto-Generated Configuration<a class="headerlink" href="#auto-generated-configuration" title="Link to this heading">¶</a></h3>
<p>The following configuration variables are automatically generated by the module and typically do not need manual configuration:</p>
<section id="community-stats-aggregations">
<h4><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_AGGREGATIONS</span></code><a class="headerlink" href="#community-stats-aggregations" title="Link to this heading">¶</a></h4>
<p>This variable contains the aggregation configurations for all statistics aggregators. It is automatically populated by the <code class="docutils literal notranslate"><span class="pre">register_aggregations()</span></code> function and includes configurations for record counts, usage statistics, and other metrics.</p>
</section>
<section id="community-stats-queries">
<h4><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_QUERIES</span></code><a class="headerlink" href="#community-stats-queries" title="Link to this heading">¶</a></h4>
<p>This variable contains the query configurations for accessing statistics data. It is automatically populated and includes configurations for different types of statistics queries.</p>
</section>
</section>
<section id="configuration-reference">
<h3>Configuration Reference<a class="headerlink" href="#configuration-reference" title="Link to this heading">¶</a></h3>
<p>The following table provides a complete reference of all available configuration variables:</p>
<div class="table-wrapper colwidths-auto docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variable</p></th>
<th class="head"><p>Default</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_ENABLED</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p>Enable/disable the entire module</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_TASKS_ENABLED</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p></td>
<td><p>Enable/disable scheduled aggregation tasks</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_CELERYBEAT_SCHEDULE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Celery beat schedule for aggregation tasks</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_CATCHUP_INTERVAL</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">365</span></code></p></td>
<td><p>Maximum days to catch up when aggregating historical data</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_AGGREGATIONS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Aggregation configurations (auto-generated)</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_QUERIES</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Query configurations (auto-generated)</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">20</span></code></p></td>
<td><p>Maximum number of items to return in subcount breakdowns</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SUBCOUNT_CONFIGS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Configuration for subcount breakdowns and field mappings</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_UI_SUBCOUNTS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>UI subcount configuration for different breakdown types</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_LOCK_CONFIG</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Distributed locking configuration for aggregation tasks</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_TEMPLATES</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Template paths for dashboard views</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_ROUTES</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>URL routes for dashboard pages</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_UI_CONFIG</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>UI configuration for dashboard appearance and behavior</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_DEFAULT_RANGE_OPTIONS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Default date range options for different granularities</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_LAYOUT</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Dashboard layout and component configuration</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ENABLED</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p>Enable/disable menu integration</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_TEXT</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">_(&quot;Statistics&quot;)</span></code></p></td>
<td><p>Menu item text</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ORDER</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1</span></code></p></td>
<td><p>Menu item order</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ENDPOINT</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">&quot;invenio_stats_dashboard.global_stats_dashboard&quot;</span></code></p></td>
<td><p>Menu item endpoint</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_REGISTRATION_FUNCTION</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></td>
<td><p>Custom menu registration function</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_USE_TEST_DATA</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p>Enable/disable test data mode for development</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_BATCHES</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">1000</span></code></p></td>
<td><p>Maximum batches per month for migration</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_BATCH_SIZE</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">5000</span></code></p></td>
<td><p>Events per batch for migration. <strong>Note: OpenSearch has a hard limit of 10,000 documents for search results, so this value cannot exceed 10,000.</strong></p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_MEMORY_PERCENT</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">85</span></code></p></td>
<td><p>Maximum memory usage percentage before stopping migration</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">STATS_EVENTS</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">{...}</span></code></p></td>
<td><p>Event type configurations for statistics processing</p></td>
</tr>
</tbody>
</table>
</div>
<p><strong>Note</strong>: Variables marked with <code class="docutils literal notranslate"><span class="pre">{...}</span></code> contain complex configuration objects that are documented in detail in the sections above.</p>
</section>
</section>
<section id="cli-commands">
<h2>CLI Commands<a class="headerlink" href="#cli-commands" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> module provides CLI commands for managing statistics infrastructure, migrating events, and monitoring progress. All commands are available as subcommands under the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span></code> command, organized into command groups.</p>
<section id="core-commands">
<h3>Core Commands<a class="headerlink" href="#core-commands" title="Link to this heading">¶</a></h3>
<section id="aggregate">
<h4><code class="docutils literal notranslate"><span class="pre">aggregate</span></code><a class="headerlink" href="#aggregate" title="Link to this heading">¶</a></h4>
<p>Manually trigger the aggregation of statistics for a community or instance.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>aggregate<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--community-id</span></code>: The UUID or slug of the community to aggregate stats for. Can be specified multiple times. If not specified, aggregates for all communities and the global instance.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start-date</span></code>: The start date to aggregate stats for (YYYY-MM-DD). Default: creation/publication/adding of the first record.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--end-date</span></code>: The end date to aggregate stats for (YYYY-MM-DD). Default: today.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--eager</span></code>: Run aggregation eagerly (synchronously) rather than asynchronously.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--update-bookmark</span></code>: Update the progress bookmark after aggregation (default: True).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--ignore-bookmark</span></code>: Ignore the progress bookmark and force a full re-aggregation.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--verbose</span></code>: Show detailed timing information for each aggregator.</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Aggregate stats for all communities and the global instance</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>aggregate

<span class="c1"># Aggregate stats for specific community</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>aggregate<span class="w"> </span>--community-id<span class="w"> </span>my-community-id

<span class="c1"># Aggregate stats for specific date range</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>aggregate<span class="w"> </span>--start-date<span class="w"> </span><span class="m">2024</span>-01-01<span class="w"> </span>--end-date<span class="w"> </span><span class="m">2024</span>-01-31

<span class="c1"># Force eager aggregation with verbose output</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>aggregate<span class="w"> </span>--eager<span class="w"> </span>--ignore-bookmark<span class="w"> </span>--verbose
</pre></div>
</div>
</section>
<section id="read">
<h4><code class="docutils literal notranslate"><span class="pre">read</span></code><a class="headerlink" href="#read" title="Link to this heading">¶</a></h4>
<p>Read and display statistics data for a community or instance.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span><span class="nb">read</span><span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--community-id</span></code>: The ID of the community to read stats for (default: “global”).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start-date</span></code>: The start date to read stats for (default: yesterday).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--end-date</span></code>: The end date to read stats for (default: today).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read global stats for yesterday</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span><span class="nb">read</span>

<span class="c1"># Read stats for specific community and date range</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span><span class="nb">read</span><span class="w"> </span>--community-id<span class="w"> </span>my-community<span class="w"> </span>--start-date<span class="w"> </span><span class="m">2024</span>-01-01<span class="w"> </span>--end-date<span class="w"> </span><span class="m">2024</span>-01-31
</pre></div>
</div>
</section>
</section>
<section id="community-events-commands">
<h3>Community Events Commands<a class="headerlink" href="#community-events-commands" title="Link to this heading">¶</a></h3>
<section id="community-events-generate">
<h4><code class="docutils literal notranslate"><span class="pre">community-events</span> <span class="pre">generate</span></code><a class="headerlink" href="#community-events-generate" title="Link to this heading">¶</a></h4>
<p>Generate community add/remove events for all records in the instance or specific records/communities.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--community-id</span></code>: The ID of the community to generate events for. Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--record-ids</span></code>: The IDs of the records to generate events for. Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start-date</span></code>: Start date for filtering records by creation date (YYYY-MM-DD). If not provided, uses earliest record creation date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--end-date</span></code>: End date for filtering records by creation date (YYYY-MM-DD). If not provided, uses current date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--show-progress</span></code>: Show progress information during processing (default: True).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate events for all records</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate

<span class="c1"># Generate events for specific community</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate<span class="w"> </span>--community-id<span class="w"> </span>my-community-slug

<span class="c1"># Generate events for specific records</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate<span class="w"> </span>--record-ids<span class="w"> </span>abc123<span class="w"> </span>def456<span class="w"> </span>ghi789

<span class="c1"># Generate events for specific date range</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate<span class="w"> </span>--start-date<span class="w"> </span><span class="m">2024</span>-01-01<span class="w"> </span>--end-date<span class="w"> </span><span class="m">2024</span>-01-31
</pre></div>
</div>
</section>
<section id="community-events-status">
<h4><code class="docutils literal notranslate"><span class="pre">community-events</span> <span class="pre">status</span></code><a class="headerlink" href="#community-events-status" title="Link to this heading">¶</a></h4>
<p>Count records that need community events created and show detailed status information.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>status<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--community-id</span></code>: The ID of the community to check. Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--record-ids</span></code>: The IDs of the records to check. Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start-date</span></code>: Start date for filtering records by creation date (YYYY-MM-DD). If not provided, uses earliest record creation date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--end-date</span></code>: End date for filtering records by creation date (YYYY-MM-DD). If not provided, uses current date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--community-details</span></code>: Show detailed community information.</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check status for all communities</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>status

<span class="c1"># Check status for specific community with details</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>status<span class="w"> </span>--community-id<span class="w"> </span>my-community<span class="w"> </span>--community-details

<span class="c1"># Check status for specific date range</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>status<span class="w"> </span>--start-date<span class="w"> </span><span class="m">2024</span>-01-01<span class="w"> </span>--end-date<span class="w"> </span><span class="m">2024</span>-01-31
</pre></div>
</div>
</section>
<section id="community-events-generate-background">
<h4><code class="docutils literal notranslate"><span class="pre">community-events</span> <span class="pre">generate-background</span></code><a class="headerlink" href="#community-events-generate-background" title="Link to this heading">¶</a></h4>
<p>Start community event generation in the background with full process management capabilities.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate-background<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--community-id</span></code>: The ID of the community to generate events for. Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--record-ids</span></code>: The IDs of the records to generate events for. Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--start-date</span></code>: Start date for filtering records by creation date (YYYY-MM-DD). If not provided, uses earliest record creation date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--end-date</span></code>: End date for filtering records by creation date (YYYY-MM-DD). If not provided, uses current date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pid-dir</span></code>: Directory to store PID and status files (default: <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start background event generation for all records</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate-background

<span class="c1"># Start background event generation for specific community</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate-background<span class="w"> </span>--community-id<span class="w"> </span>my-community-slug

<span class="c1"># Use custom PID directory</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>community-events<span class="w"> </span>generate-background<span class="w"> </span>--pid-dir<span class="w"> </span>/var/run/invenio-community-stats
</pre></div>
</div>
<p><strong>Process Management:</strong></p>
<ul class="simple">
<li><p>Process name: <code class="docutils literal notranslate"><span class="pre">community-event-generation</span></code></p></li>
<li><p>Monitor progress: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">status</span> <span class="pre">community-event-generation</span></code></p></li>
<li><p>Cancel process: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">cancel</span> <span class="pre">community-event-generation</span></code></p></li>
<li><p>View logs: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">status</span> <span class="pre">community-event-generation</span> <span class="pre">--show-log</span></code></p></li>
</ul>
</section>
</section>
<section id="usage-events-commands">
<h3>Usage Events Commands<a class="headerlink" href="#usage-events-commands" title="Link to this heading">¶</a></h3>
<section id="usage-events-generate">
<h4><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">generate</span></code><a class="headerlink" href="#usage-events-generate" title="Link to this heading">¶</a></h4>
<p>Generate synthetic usage events (view/download) for testing purposes using the UsageEventFactory.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--start-date</span></code>: Start date for filtering records by creation date (YYYY-MM-DD). If not provided, uses earliest record creation date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--end-date</span></code>: End date for filtering records by creation date (YYYY-MM-DD). If not provided, uses current date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--event-start-date</span></code>: Start date for event timestamps (YYYY-MM-DD). If not provided, uses start-date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--event-end-date</span></code>: End date for event timestamps (YYYY-MM-DD). If not provided, uses end-date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--events-per-record</span></code>: Number of events to generate per record (default: 5).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max-records</span></code>: Maximum number of records to process (default: 0 = all records).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--enrich-events</span></code>: Enrich events with additional data matching extended fields.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--dry-run</span></code>: Generate events but don’t index them.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--yes-i-know</span></code>: Skip confirmation prompt.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--use-migrated-indices</span></code>: Use migrated indices with -v2.0.0 suffix when they exist.</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Generate 5 events per record for all records</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate

<span class="c1"># Generate events for specific date range</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--start-date<span class="w"> </span><span class="m">2024</span>-01-01<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--end-date<span class="w"> </span><span class="m">2024</span>-01-31<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--events-per-record<span class="w"> </span><span class="m">10</span>

<span class="c1"># Dry run to see what would be generated</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate<span class="w"> </span>--dry-run

<span class="c1"># Generate enriched events for limited records</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-records<span class="w"> </span><span class="m">100</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--enrich-events<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--events-per-record<span class="w"> </span><span class="m">3</span>
</pre></div>
</div>
</section>
<section id="usage-events-generate-background">
<h4><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">generate-background</span></code><a class="headerlink" href="#usage-events-generate-background" title="Link to this heading">¶</a></h4>
<p>Start usage event generation in the background with full process management capabilities.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate-background<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--start-date</span></code>: Start date for filtering records by creation date (YYYY-MM-DD). If not provided, uses earliest record creation date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--end-date</span></code>: End date for filtering records by creation date (YYYY-MM-DD). If not provided, uses current date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--event-start-date</span></code>: Start date for event timestamps (YYYY-MM-DD). If not provided, uses start-date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--event-end-date</span></code>: End date for event timestamps (YYYY-MM-DD). If not provided, uses end-date.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--events-per-record</span></code>: Number of events to generate per record (default: 5).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max-records</span></code>: Maximum number of records to process (default: 0 = all records).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--enrich-events</span></code>: Enrich events with additional data matching extended fields.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pid-dir</span></code>: Directory to store PID and status files (default: <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start background usage event generation</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate-background

<span class="c1"># Start with custom parameters</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate-background<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--start-date<span class="w"> </span><span class="m">2024</span>-01-01<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--end-date<span class="w"> </span><span class="m">2024</span>-01-31<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--events-per-record<span class="w"> </span><span class="m">10</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--enrich-events

<span class="c1"># Use custom PID directory</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>generate-background<span class="w"> </span>--pid-dir<span class="w"> </span>/var/run/invenio-community-stats
</pre></div>
</div>
<p><strong>Process Management:</strong></p>
<ul class="simple">
<li><p>Process name: <code class="docutils literal notranslate"><span class="pre">usage-event-generation</span></code></p></li>
<li><p>Monitor progress: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">status</span> <span class="pre">usage-event-generation</span></code></p></li>
<li><p>Cancel process: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">cancel</span> <span class="pre">usage-event-generation</span></code></p></li>
<li><p>View logs: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">status</span> <span class="pre">usage-event-generation</span> <span class="pre">--show-log</span></code></p></li>
</ul>
</section>
<section id="usage-events-migrate">
<h4><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">migrate</span></code><a class="headerlink" href="#usage-events-migrate" title="Link to this heading">¶</a></h4>
<p>Migrate existing usage (view and download) events to enriched indices with community and record metadata.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--event-types,</span> <span class="pre">-e</span></code>: Event types to migrate (view, download). Can be specified multiple times. Defaults to both.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max-batches,</span> <span class="pre">-b</span></code>: Maximum batches to process per month (default from <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_BATCHES</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--batch-size</span></code>: Number of events to process per batch (default from <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_BATCH_SIZE</span></code>; max 10,000).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max-memory-percent</span></code>: Maximum memory usage percentage before stopping (default from <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_MEMORY_PERCENT</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--dry-run</span></code>: Show what would be migrated without doing it.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--async</span></code>: Run reindexing asynchronously using Celery.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--delete-old-indices</span></code>: Delete old indices after migration (default is to keep them).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Basic migration for all event types</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate

<span class="c1"># Dry run to see what would be migrated</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate<span class="w"> </span>--dry-run

<span class="c1"># Limit batches for testing</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate<span class="w"> </span>--max-batches<span class="w"> </span><span class="m">10</span>

<span class="c1"># Migrate only view events</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate<span class="w"> </span>--event-types<span class="w"> </span>view

<span class="c1"># Run asynchronously with custom settings</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate<span class="w"> </span>--async<span class="w"> </span>--batch-size<span class="w"> </span><span class="m">500</span><span class="w"> </span>--max-memory-percent<span class="w"> </span><span class="m">70</span>
</pre></div>
</div>
</section>
<section id="usage-events-migrate-background">
<h4><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">migrate-background</span></code><a class="headerlink" href="#usage-events-migrate-background" title="Link to this heading">¶</a></h4>
<p>Start event migration in the background with full process management capabilities.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate-background<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--event-types,</span> <span class="pre">-e</span></code>: Event types to migrate (view, download). Can be specified multiple times. Defaults to both.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max-batches,</span> <span class="pre">-b</span></code>: Maximum batches to process per month.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--batch-size</span></code>: Number of events to process per batch (default: 1000).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--max-memory-percent</span></code>: Maximum memory usage percentage before stopping (default: 85).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--delete-old-indices</span></code>: Delete old indices after migration.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pid-dir</span></code>: Directory to store PID and status files (default: <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start background migration for all event types</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate-background

<span class="c1"># Start background migration with custom settings</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate-background<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--event-types<span class="w"> </span>view<span class="w"> </span>download<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--batch-size<span class="w"> </span><span class="m">500</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-memory-percent<span class="w"> </span><span class="m">70</span><span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--max-batches<span class="w"> </span><span class="m">100</span>

<span class="c1"># Use custom PID directory</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>migrate-background<span class="w"> </span>--pid-dir<span class="w"> </span>/var/run/invenio-community-stats
</pre></div>
</div>
<p><strong>Process Management:</strong></p>
<ul class="simple">
<li><p>Process name: <code class="docutils literal notranslate"><span class="pre">event-migration</span></code></p></li>
<li><p>Monitor progress: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">status</span> <span class="pre">event-migration</span></code></p></li>
<li><p>Cancel process: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">cancel</span> <span class="pre">event-migration</span></code></p></li>
<li><p>View logs: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">processes</span> <span class="pre">status</span> <span class="pre">event-migration</span> <span class="pre">--show-log</span></code></p></li>
</ul>
</section>
<section id="usage-events-status">
<h4><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">status</span></code><a class="headerlink" href="#usage-events-status" title="Link to this heading">¶</a></h4>
<p>Show the current migration status and progress across all monthly indices.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>status<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--show-bookmarks</span></code>: Show detailed bookmark information for each month.</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Show basic migration status</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>status

<span class="c1"># Show detailed status with bookmarks</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>status<span class="w"> </span>--show-bookmarks
</pre></div>
</div>
</section>
<section id="usage-events-clear-bookmarks">
<h4><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">clear-bookmarks</span></code><a class="headerlink" href="#usage-events-clear-bookmarks" title="Link to this heading">¶</a></h4>
<p>Clear migration bookmarks for specific months or all months.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>clear-bookmarks<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--event-type</span></code>: Event type to clear bookmarks for (view, download). Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--months</span></code>: Months to clear bookmarks for (YYYY-MM). Can be specified multiple times.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--fresh-start</span></code>: Clear all bookmarks and start fresh.</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Clear bookmarks for all months and event types</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>clear-bookmarks<span class="w"> </span>--fresh-start

<span class="c1"># Clear bookmarks for specific month and event type</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>clear-bookmarks<span class="w"> </span>--event-type<span class="w"> </span>view<span class="w"> </span>--months<span class="w"> </span><span class="m">2024</span>-01

<span class="c1"># Clear bookmarks for multiple months</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>usage-events<span class="w"> </span>clear-bookmarks<span class="w"> </span>--months<span class="w"> </span><span class="m">2024</span>-01<span class="w"> </span>--months<span class="w"> </span><span class="m">2024</span>-02
</pre></div>
</div>
</section>
</section>
<section id="process-management-commands">
<h3>Process Management Commands<a class="headerlink" href="#process-management-commands" title="Link to this heading">¶</a></h3>
<p>These commands provide monitoring and control capabilities for background processes started with the <code class="docutils literal notranslate"><span class="pre">*-background</span></code> commands.</p>
<section id="processes-status">
<h4><code class="docutils literal notranslate"><span class="pre">processes</span> <span class="pre">status</span></code><a class="headerlink" href="#processes-status" title="Link to this heading">¶</a></h4>
<p>Monitor the status of a running background process.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>status<span class="w"> </span>&lt;process-name&gt;<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Arguments:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">process-name</span></code>: Name of the process to monitor (e.g., <code class="docutils literal notranslate"><span class="pre">event-migration</span></code>, <code class="docutils literal notranslate"><span class="pre">community-event-generation</span></code>, <code class="docutils literal notranslate"><span class="pre">usage-event-generation</span></code>).</p></li>
</ul>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--show-log</span></code>: Show recent log output from the process.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--log-lines</span></code>: Number of log lines to show (default: 20).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pid-dir</span></code>: Directory containing PID and status files (default: <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Check basic status</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>status<span class="w"> </span>event-migration

<span class="c1"># Show recent logs</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>status<span class="w"> </span>event-migration<span class="w"> </span>--show-log

<span class="c1"># Show more log lines</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>status<span class="w"> </span>event-migration<span class="w"> </span>--show-log<span class="w"> </span>--log-lines<span class="w"> </span><span class="m">50</span>
</pre></div>
</div>
</section>
<section id="processes-cancel">
<h4><code class="docutils literal notranslate"><span class="pre">processes</span> <span class="pre">cancel</span></code><a class="headerlink" href="#processes-cancel" title="Link to this heading">¶</a></h4>
<p>Gracefully cancel a running background process.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>cancel<span class="w"> </span>&lt;process-name&gt;<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Arguments:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">process-name</span></code>: Name of the process to cancel (e.g., <code class="docutils literal notranslate"><span class="pre">event-migration</span></code>, <code class="docutils literal notranslate"><span class="pre">community-event-generation</span></code>, <code class="docutils literal notranslate"><span class="pre">usage-event-generation</span></code>).</p></li>
</ul>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--timeout</span></code>: Seconds to wait for graceful shutdown before force kill (default: 30).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--pid-dir</span></code>: Directory containing PID files (default: <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cancel with default timeout</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>cancel<span class="w"> </span>event-migration

<span class="c1"># Cancel with custom timeout</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>cancel<span class="w"> </span>event-migration<span class="w"> </span>--timeout<span class="w"> </span><span class="m">60</span>
</pre></div>
</div>
</section>
<section id="processes-list">
<h4><code class="docutils literal notranslate"><span class="pre">processes</span> <span class="pre">list</span></code><a class="headerlink" href="#processes-list" title="Link to this heading">¶</a></h4>
<p>List all currently running background processes.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>list<span class="w"> </span><span class="o">[</span>OPTIONS<span class="o">]</span>
</pre></div>
</div>
<p><strong>Options:</strong></p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">--pid-dir</span></code>: Directory containing PID files (default: <code class="docutils literal notranslate"><span class="pre">/tmp</span></code>).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--package-only</span></code>: Only show processes managed by invenio-stats-dashboard.</p></li>
</ul>
<p><strong>Examples:</strong></p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># List all processes</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>list

<span class="c1"># List only package processes</span>
invenio<span class="w"> </span>community-stats<span class="w"> </span>processes<span class="w"> </span>list<span class="w"> </span>--package-only
</pre></div>
</div>
</section>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          
          
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, MESH Research
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/MESH-Research/invenio-stats-dashboard" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Invenio Stats Dashboard</a><ul>
<li><a class="reference internal" href="#current-known-issues">Current Known Issues</a></li>
<li><a class="reference internal" href="#overview">Overview</a></li>
<li><a class="reference internal" href="#todos">TODOs</a></li>
<li><a class="reference internal" href="#architecture">Architecture</a><ul>
<li><a class="reference internal" href="#building-on-the-invenio-stats-module">Building on the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module</a></li>
<li><a class="reference internal" href="#data-layer">Data layer</a><ul>
<li><a class="reference internal" href="#community-membership-events">Community membership events</a></li>
<li><a class="reference internal" href="#enriched-record-usage-events">Enriched record usage events</a></li>
<li><a class="reference internal" href="#aggregated-statistics">Aggregated statistics</a></li>
<li><a class="reference internal" href="#daily-record-deltas">Daily record deltas</a></li>
<li><a class="reference internal" href="#daily-record-snapshots">Daily record snapshots</a></li>
<li><a class="reference internal" href="#usage-deltas">Usage deltas</a></li>
<li><a class="reference internal" href="#usage-snapshots">Usage snapshots</a></li>
<li><a class="reference internal" href="#search-index-configuration">Search index configuration</a></li>
</ul>
</li>
<li><a class="reference internal" href="#service-layer">Service layer</a><ul>
<li><a class="reference internal" href="#aggregator-classes">Aggregator classes</a></li>
<li><a class="reference internal" href="#scheduled-aggregation-of-statistics">Scheduled aggregation of statistics</a></li>
<li><a class="reference internal" href="#aggregation-task-locking-and-catch-up-limits">Aggregation task locking and catch-up limits</a></li>
<li><a class="reference internal" href="#service-components-for-community-event-tracking">Service components for community event tracking</a></li>
<li><a class="reference internal" href="#programmatic-statistics-access-service">Programmatic statistics access service</a></li>
<li><a class="reference internal" href="#helper-class-for-usage-event-index-migration">Helper class for usage event index migration</a></li>
<li><a class="reference internal" href="#utilities-for-generating-testing-data">Utilities for generating testing data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#presentation-layer">Presentation layer</a><ul>
<li><a class="reference internal" href="#dashboard-templates">Dashboard templates</a></li>
<li><a class="reference internal" href="#views-and-routes">Views and routes</a></li>
<li><a class="reference internal" href="#api-queries">API queries</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#setup-and-migration">Setup and Migration</a><ul>
<li><a class="reference internal" href="#search-index-template-registration">Search index template registration</a></li>
<li><a class="reference internal" href="#initial-indexing-of-community-addition-events">Initial indexing of community addition events</a></li>
<li><a class="reference internal" href="#initial-migration-of-existing-view-download-events">Initial migration of existing view/download events</a><ul>
<li><a class="reference internal" href="#preventing-overload-of-opensearch-or-memory">Preventing overload of OpenSearch or memory</a></li>
<li><a class="reference internal" href="#handling-failures">Handling failures</a></li>
<li><a class="reference internal" href="#handling-progress-across-migration-runs">Handling progress across migration runs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#initial-aggregation-of-historical-data">Initial aggregation of historical data</a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#blueprints-and-routes">Blueprints and routes</a></li>
<li><a class="reference internal" href="#jinja2-templates">Jinja2 templates</a></li>
<li><a class="reference internal" href="#enabling-the-global-dashboard-template">Enabling the global dashboard template</a></li>
<li><a class="reference internal" href="#enabling-the-community-dashboard-template">Enabling the community dashboard template</a></li>
<li><a class="reference internal" href="#customizing-the-layout-of-your-dashboard">Customizing the layout of your dashboard</a><ul>
<li><a class="reference internal" href="#layout-configuration-structure">Layout Configuration Structure</a></li>
<li><a class="reference internal" href="#available-components">Available Components</a></li>
<li><a class="reference internal" href="#component-properties">Component Properties</a></li>
</ul>
</li>
<li><a class="reference internal" href="#global-ui-configuration">Global UI Configuration</a><ul>
<li><a class="reference internal" href="#customization-examples">Customization Examples</a></li>
</ul>
</li>
<li><a class="reference internal" href="#adding-dashboard-views-to-other-pages">Adding dashboard views to other pages</a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration">Configuration</a><ul>
<li><a class="reference internal" href="#configuration-overrides">Configuration Overrides</a></li>
<li><a class="reference internal" href="#module-enable-disable">Module Enable/Disable</a></li>
<li><a class="reference internal" href="#scheduled-tasks-enable-disable">Scheduled Tasks Enable/Disable</a></li>
<li><a class="reference internal" href="#view-download-event-migration">View/Download event migration</a></li>
<li><a class="reference internal" href="#task-scheduling-and-aggregation">Task scheduling and aggregation</a></li>
<li><a class="reference internal" href="#aggregation-task-locking">Aggregation task locking</a></li>
<li><a class="reference internal" href="#default-range-options">Default range options</a></li>
<li><a class="reference internal" href="#menu-configuration">Menu configuration</a></li>
<li><a class="reference internal" href="#dashboard-layout-and-components">Dashboard layout and components</a></li>
<li><a class="reference internal" href="#routes">Routes</a></li>
<li><a class="reference internal" href="#templates">Templates</a></li>
<li><a class="reference internal" href="#ui-configuration">UI Configuration</a><ul>
<li><a class="reference internal" href="#title-and-description-display">Title and description display</a></li>
</ul>
</li>
<li><a class="reference internal" href="#subcount-configuration">Subcount Configuration</a><ul>
<li><a class="reference internal" href="#community-stats-top-subcount-limit"><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_TOP_SUBCOUNT_LIMIT</span></code></a></li>
<li><a class="reference internal" href="#community-stats-subcount-configs"><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SUBCOUNT_CONFIGS</span></code></a></li>
<li><a class="reference internal" href="#stats-dashboard-ui-subcounts"><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_UI_SUBCOUNTS</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#test-data-mode">Test Data Mode</a><ul>
<li><a class="reference internal" href="#stats-dashboard-use-test-data"><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_USE_TEST_DATA</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#event-processing-configuration">Event Processing Configuration</a><ul>
<li><a class="reference internal" href="#stats-events"><code class="docutils literal notranslate"><span class="pre">STATS_EVENTS</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#auto-generated-configuration">Auto-Generated Configuration</a><ul>
<li><a class="reference internal" href="#community-stats-aggregations"><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_AGGREGATIONS</span></code></a></li>
<li><a class="reference internal" href="#community-stats-queries"><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_QUERIES</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#configuration-reference">Configuration Reference</a></li>
</ul>
</li>
<li><a class="reference internal" href="#cli-commands">CLI Commands</a><ul>
<li><a class="reference internal" href="#core-commands">Core Commands</a><ul>
<li><a class="reference internal" href="#aggregate"><code class="docutils literal notranslate"><span class="pre">aggregate</span></code></a></li>
<li><a class="reference internal" href="#read"><code class="docutils literal notranslate"><span class="pre">read</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#community-events-commands">Community Events Commands</a><ul>
<li><a class="reference internal" href="#community-events-generate"><code class="docutils literal notranslate"><span class="pre">community-events</span> <span class="pre">generate</span></code></a></li>
<li><a class="reference internal" href="#community-events-status"><code class="docutils literal notranslate"><span class="pre">community-events</span> <span class="pre">status</span></code></a></li>
<li><a class="reference internal" href="#community-events-generate-background"><code class="docutils literal notranslate"><span class="pre">community-events</span> <span class="pre">generate-background</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#usage-events-commands">Usage Events Commands</a><ul>
<li><a class="reference internal" href="#usage-events-generate"><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">generate</span></code></a></li>
<li><a class="reference internal" href="#usage-events-generate-background"><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">generate-background</span></code></a></li>
<li><a class="reference internal" href="#usage-events-migrate"><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">migrate</span></code></a></li>
<li><a class="reference internal" href="#usage-events-migrate-background"><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">migrate-background</span></code></a></li>
<li><a class="reference internal" href="#usage-events-status"><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">status</span></code></a></li>
<li><a class="reference internal" href="#usage-events-clear-bookmarks"><code class="docutils literal notranslate"><span class="pre">usage-events</span> <span class="pre">clear-bookmarks</span></code></a></li>
</ul>
</li>
<li><a class="reference internal" href="#process-management-commands">Process Management Commands</a><ul>
<li><a class="reference internal" href="#processes-status"><code class="docutils literal notranslate"><span class="pre">processes</span> <span class="pre">status</span></code></a></li>
<li><a class="reference internal" href="#processes-cancel"><code class="docutils literal notranslate"><span class="pre">processes</span> <span class="pre">cancel</span></code></a></li>
<li><a class="reference internal" href="#processes-list"><code class="docutils literal notranslate"><span class="pre">processes</span> <span class="pre">list</span></code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=c5ea77a9"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>