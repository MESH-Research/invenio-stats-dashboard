<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="Index" href="genindex.html"><link rel="search" title="Search" href="search.html"><link rel="next" title="Usage" href="usage.html"><link rel="prev" title="Architecture" href="architecture.html">

    <!-- Generated with Sphinx 8.2.3 and Furo 2025.09.25 -->
        <title>Setup and Migration - Invenio Stats Dashboard 0.1.0-alpha1 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=d111a655" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=580074bf" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=8dab3a3b" />
    
    


<style>
  body {
    --color-code-background: #f2f2f2;
  --color-code-foreground: #1e1e1e;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle site navigation sidebar">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc" aria-label="Toggle table of contents sidebar">
<label class="overlay sidebar-overlay" for="__navigation"></label>
<label class="overlay toc-overlay" for="__toc"></label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>

<div class="announcement">
  <aside class="announcement-content">
     ⚠️  This is a pre-alpha package. Things may be broken. <a href='https://github.com/MESH-Research/invenio-stats-dashboard' target='_blank'>View on GitHub</a> 
  </aside>
</div>

<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <span class="icon"><svg><use href="#svg-menu"></use></svg></span>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">Invenio Stats Dashboard 0.1.0-alpha1 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  <span class="sidebar-brand-text">Invenio Stats Dashboard 0.1.0-alpha1 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Invenio Stats Dashboard</a></li>
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="todos.html">TODOs</a></li>
<li class="toctree-l1"><a class="reference internal" href="known_issues.html">Known Issues</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Setup and Migration</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli.html">CLI Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_requests.html">API Requests</a></li>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changelog</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          <div class="view-this-page">
  <a class="muted-link" href="https://github.com/MESH-Research/invenio-stats-dashboard/blob/main/docs/source/setup.md?plain=true" title="View this page">
    <svg><use href="#svg-eye"></use></svg>
    <span class="visually-hidden">View this page</span>
  </a>
</div><div class="edit-this-page">
  <a class="muted-link" href="https://github.com/MESH-Research/invenio-stats-dashboard/edit/main/docs/source/setup.md" rel="edit" title="Edit this page">
    <svg><use href="#svg-pencil"></use></svg>
    <span class="visually-hidden">Edit this page</span>
  </a>
</div><div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle" aria-label="Toggle Light / Dark / Auto color theme">
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <span class="icon"><svg><use href="#svg-toc"></use></svg></span>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="setup-and-migration">
<h1>Setup and Migration<a class="headerlink" href="#setup-and-migration" title="Link to this heading">¶</a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>This package is waiting for two pull requests to be merged in invenio-requests and invenio-rdm-records (see <a class="reference internal" href="known_issues.html"><span class="std std-doc">Known Issues</span></a>). In the meantime, a provided bash script is provided to patch the required files in your local site-packages directory. Simply run <code class="docutils literal notranslate"><span class="pre">bash</span> <span class="pre">apply_patches.sh</span> <span class="pre">[environment_path]</span></code> from the root of the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> package directory, where <code class="docutils literal notranslate"><span class="pre">[environment_path]</span></code> is the path to your python environment folder (the parent folder of <code class="docutils literal notranslate"><span class="pre">site-packages</span></code>). You can view the contents of the patched files in the <code class="docutils literal notranslate"><span class="pre">invenio_stats_dashboard/patches</span></code> directory.</p>
</div>
<p>In future the plan is that setup of <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> will involve simply installing the python package and restarting the InvenioRDM instance. For now, however, two initial setup tasks are required <strong>only for existing InvenioRDM instances</strong> that already have records and view/download statistics:</p>
<ul class="simple">
<li><p>index community addition events for all existing records</p></li>
<li><p>migrate the existing view and download events to the new index templates and enrich them with community and record metadata</p></li>
</ul>
<p>These tasks can be performed manually via CLI commands detailed below. They require zero downtime and can be performed in the background on a running InvenioRDM instance.</p>
<p>After these tasks are completed, the extension will be ready to use as normal. The catch-up aggregation of historical statistics will then be performed automatically as part of the scheduled aggregation tasks. Since this can, however, be a long process, especially for large instances, a utility CLI command to perform the catch-up aggregation manually is also provided.</p>
<p>So the full setup process is currently:</p>
<ol class="arabic simple">
<li><p>Install the python package</p></li>
<li><p>Set config variables for the setup period:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_AGG_TASKS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_CACHE_TASKS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">False</span></code></p></li>
</ul>
<ol class="arabic simple" start="3">
<li><p>Restart the InvenioRDM instance</p></li>
<li><p>Initialize the community custom field (via CLI command)</p></li>
<li><p>Index community addition events for all existing records (via CLI command)</p></li>
<li><p>Migrate and enrich the existing view and download events (via CLI command)</p></li>
<li><p>OPTIONAL: Manually run the catch-up aggregation (via CLI command)</p></li>
<li><p>Set config variables for normal operation:</p></li>
</ol>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_AGG_TASKS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">COMMUNITY_STATS_SCHEDULED_CACHE_TASKS_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_MENU_ENABLED</span></code> = <code class="docutils literal notranslate"><span class="pre">True</span></code> (if desired)</p></li>
</ul>
<ol class="arabic simple" start="9">
<li><p>Set up other configuration and community page templates as desired</p></li>
<li><p>Restart the InvenioRDM instance</p></li>
</ol>
<section id="community-custom-field-initialization">
<h2>Community Custom Field Initialization<a class="headerlink" href="#community-custom-field-initialization" title="Link to this heading">¶</a></h2>
<p>The extension provides a custom field (<code class="docutils literal notranslate"><span class="pre">stats:dashboard_layout</span></code>) for communities to store dashboard layout configurations. This field must be initialized in the search index before it can be used:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initialize the custom field</span>
invenio<span class="w"> </span>custom-fields<span class="w"> </span>communities<span class="w"> </span>init<span class="w"> </span>stats:dashboard_layout

<span class="c1"># Verify the field exists</span>
invenio<span class="w"> </span>custom-fields<span class="w"> </span>communities<span class="w"> </span>exists<span class="w"> </span>stats:dashboard_layout
</pre></div>
</div>
<p><strong>Note</strong>: This step is required for both new and existing InvenioRDM instances. The custom field provides community-specific dashboard customization capabilities and is automatically integrated into community creation and editing forms.</p>
</section>
<section id="search-index-template-registration">
<h2>Search index template registration<a class="headerlink" href="#search-index-template-registration" title="Link to this heading">¶</a></h2>
<p>If the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension is installed on a new InvenioRDM instance, the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module will automatically register the extension’s search index templates with the OpenSearch domain. But <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> does not automatically do this registration for existing InvenioRDM instances, i.e. if the main OpenSearch index setup has already been performed. So the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension will check at application startup to ensure that the extension’s search index templates are registered with the OpenSearch domain. If they are not, it registers them with the <code class="docutils literal notranslate"><span class="pre">invenio-search</span></code> module and puts them to OpenSearch. The aggregation indices will then be created automatically when the first records are indexed.</p>
<p>Registration of the expanded index templates for view and download events happens automatically as part of the usage event migration process.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since the included search index tamplates all use the new-style index templates, you must ensure that STATS_REGISTER_INDEX_TEMPLATES is set to True. This is currently <em>not</em> the default for InvenioRDM instances, but it should not interfere with any other packages. The only other index templates currently registered are those from the <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> module, which are overridden by the <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension.</p>
</div>
</section>
<section id="initial-indexing-of-community-addition-events">
<h2>Initial indexing of community addition events<a class="headerlink" href="#initial-indexing-of-community-addition-events" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> requires a dedicated search index to store data about when each record was added to or removed from a community. The <code class="docutils literal notranslate"><span class="pre">CommunityStatsService.generate_record_community_events</span></code> method will create community add/remove events for all records in the instance that do not already have events. This method can be run manually via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">generate-community-events</span></code> CLI command. For details, see the <a class="reference internal" href="#cli-commands"><span class="xref myst">CLI commands</span></a> section below.</p>
</section>
<section id="initial-migration-of-existing-view-download-events">
<h2>Initial migration of existing view/download events<a class="headerlink" href="#initial-migration-of-existing-view-download-events" title="Link to this heading">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">invenio-stats-dashboard</span></code> extension also depends on an expanded field schema for the view and download events, adding to the core <code class="docutils literal notranslate"><span class="pre">invenio-stats</span></code> schema additional fields for community and for any configured record metadata that are to be made available as subcount breakdowns in statistics.</p>
<p>A dedicated CLI command is provided to (a) register the new index templates and (b) migrate and enrich any existing view and download events. For details, see the <a class="reference internal" href="#cli-commands"><span class="xref myst">CLI commands</span></a> section below.</p>
<p>The migration and enrichment process are handled by the <code class="docutils literal notranslate"><span class="pre">EventReindexingService</span></code>. If there are no existing view or download events, the service’s <code class="docutils literal notranslate"><span class="pre">reindex_events</span></code> method will simply register the new index templates and usage events can be indexed normally. If there are existing view or download events, the <code class="docutils literal notranslate"><span class="pre">reindex_events</span></code> method will perform the following steps:</p>
<ol class="arabic simple">
<li><p>Verify that the new index templates are registered with the OpenSearch domain and register them if they are not.</p></li>
<li><p>Create new monthly view and download indices for each legacy monthly index, adding the suffix <code class="docutils literal notranslate"><span class="pre">.v2.0.0</span></code> to the index names.</p></li>
<li><p>Copy the events from the legacy monthly indices to the new monthly indices, adding the community and record metadata fields to the events.</p></li>
<li><p>Confirm that the events have all been copied over accurately.</p></li>
<li><p>Update the read aliases (<code class="docutils literal notranslate"><span class="pre">events-stats-record-view</span></code> and <code class="docutils literal notranslate"><span class="pre">events-stats-file-download</span></code>) to point to the new monthly indices.</p></li>
<li><p>Delete the legacy monthly indices for months prior to the current month (if desired).</p></li>
<li><p>Switch new event writes from the old current-month index to the new current-month index by:</p>
<ul class="simple">
<li><p>creating a temporary backup copy of the old current-month index (named <code class="docutils literal notranslate"><span class="pre">backup-{old_index}</span></code>)</p></li>
<li><p>quickly deleting the old current-month index and creating a write alias to the new current-month index</p></li>
<li><p>recovering any events that arrived since the original enriched index creation from the backup index to the new enriched index</p></li>
<li><p>validating the enriched index integrity before (optionally) deleting the temporary backup index</p></li>
</ul>
</li>
</ol>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Currently, the <code class="docutils literal notranslate"><span class="pre">EventReindexingService.reindex_events</span></code> method must be run manually to perform the migration. It can be run via the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">migrate-events</span></code> CLI command and its associated helper commands. In future, the migration will be integrated automatically as part of the scheduled aggregation tasks, to be completed in the background over a series of scheduled runs before the first aggregations are actually performed.</p>
</div>
<p>TODO: set up check and automatic migration in aggregator tasks</p>
<section id="preventing-overload-of-opensearch-or-memory">
<h3>Preventing overload of OpenSearch or memory<a class="headerlink" href="#preventing-overload-of-opensearch-or-memory" title="Link to this heading">¶</a></h3>
<p>The reindexing service is configured to run in batches, to avoid overwhelming the OpenSearch domain with too many concurrent requests. The batch size and maximum number of batches can be configured via the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_BATCH_SIZE</span></code> and <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_BATCHES</span></code> configuration variables.</p>
<div class="admonition important">
<p class="admonition-title">Important</p>
<p>OpenSearch has a hard limit of 10,000 documents for search results. This means <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_BATCH_SIZE</span></code> cannot exceed 10,000, and any attempt to count documents after a search_after position will be limited to 10,000 results maximum.</p>
</div>
<p>The service will also check the memory usage of the OpenSearch domain on starting each batch and exit if the memory usage exceeds the <code class="docutils literal notranslate"><span class="pre">STATS_DASHBOARD_REINDEXING_MAX_MEMORY_PERCENT</span></code> configuration variable. The service will also check the health of the OpenSearch domain on starting each batch and exit if the health is not good.</p>
</section>
<section id="handling-failures">
<h3>Handling failures<a class="headerlink" href="#handling-failures" title="Link to this heading">¶</a></h3>
<p>If the reindexing of a particular month fails, the service will leave the original index in place and continue with the next month. It will log a warning and report the failure in the service’s output report. The service will reset that index’s bookmark to the beginning and try to reindex the month again on the next run. Alternately, you may manually retry the migration of a particular month by running the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">migrate</span></code> CLI command with its <code class="docutils literal notranslate"><span class="pre">--months</span></code> option set to the month in question and its <code class="docutils literal notranslate"><span class="pre">--event-types</span></code> option set to the event type in question.</p>
<p>For more information about failed migrations and how to retry them, you can use the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">status</span></code> CLI command.</p>
</section>
<section id="handling-progress-across-migration-runs">
<h3>Handling progress across migration runs<a class="headerlink" href="#handling-progress-across-migration-runs" title="Link to this heading">¶</a></h3>
<p>If the service hits the maximum number of batches before a monthly index is completely migrated, it will log a warning and report the progress in the service’s output report. The service will set a bookmark to record the last processed event id, so that the next reindexing service run can continue from that point. These bookmarks are stored in the <code class="docutils literal notranslate"><span class="pre">stats-community-events-reindexing</span></code> index and are set independently for each monthly index.</p>
<p>If you wish to clear the bookmarks for a particular month, you can use the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">clear-bookmarks</span></code> CLI command with its <code class="docutils literal notranslate"><span class="pre">--months</span></code> option set to the month in question, and its <code class="docutils literal notranslate"><span class="pre">--event-types</span></code> option set to the event type in question, and the <code class="docutils literal notranslate"><span class="pre">--fresh-start</span></code> flag.</p>
<p>To clear the bookmarks for all months, you can use the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">usage-events</span> <span class="pre">clear-bookmarks</span></code> CLI command.</p>
</section>
</section>
<section id="initial-aggregation-of-historical-data">
<h2>Initial aggregation of historical data<a class="headerlink" href="#initial-aggregation-of-historical-data" title="Link to this heading">¶</a></h2>
<p>The extension will perform the initial aggregation of historical statistics automatically as part of the scheduled aggregation tasks. This can be a long process, especially for large instances, so a utility CLI command to perform the catch-up aggregation manually is also provided: <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">aggregate</span></code>. This gives the instance maintainer more control over the process and can still run in the background while the instance is in use. For details, see the <a class="reference internal" href="#cli-commands"><span class="xref myst">CLI commands</span></a> section below.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>Monitoring Progress</strong>: You can monitor the progress of the catch-up aggregation using the <code class="docutils literal notranslate"><span class="pre">invenio</span> <span class="pre">community-stats</span> <span class="pre">status</span></code> command. This command shows the current state of all aggregation indices, including bookmark dates, document counts, and visual completeness bars. For more details, see the <a class="reference internal" href="#cli-commands"><span class="xref myst">CLI commands</span></a> section below.</p>
</div>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="usage.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">Usage</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="architecture.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Architecture</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2025, MESH Research
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            <div class="icons">
              <a class="muted-link " href="https://github.com/MESH-Research/invenio-stats-dashboard" aria-label="GitHub">
                <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
                </svg>
            </a>
              
            </div>
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Setup and Migration</a><ul>
<li><a class="reference internal" href="#community-custom-field-initialization">Community Custom Field Initialization</a></li>
<li><a class="reference internal" href="#search-index-template-registration">Search index template registration</a></li>
<li><a class="reference internal" href="#initial-indexing-of-community-addition-events">Initial indexing of community addition events</a></li>
<li><a class="reference internal" href="#initial-migration-of-existing-view-download-events">Initial migration of existing view/download events</a><ul>
<li><a class="reference internal" href="#preventing-overload-of-opensearch-or-memory">Preventing overload of OpenSearch or memory</a></li>
<li><a class="reference internal" href="#handling-failures">Handling failures</a></li>
<li><a class="reference internal" href="#handling-progress-across-migration-runs">Handling progress across migration runs</a></li>
</ul>
</li>
<li><a class="reference internal" href="#initial-aggregation-of-historical-data">Initial aggregation of historical data</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=c5ea77a9"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=46bd48cc"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    </body>
</html>